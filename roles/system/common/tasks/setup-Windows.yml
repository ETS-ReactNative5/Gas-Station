---
- name: Ensure the hostname is correct
  win_shell: "Rename-Computer -NewName {{ hostname }}"
  when: hostname is defined

- name: Activate Windows 10
  win_shell: "cscript slmgr.vbs /ipk {{ windows_enterprise_key }}"
  args:
    chdir: C:\Windows\System32\
  when: windows_activation_key is defined

- name: Install Windows updates
  win_updates:
    category_names:
    - CriticalUpdates
    - SecurityUpdates
    - UpdateRollups
    state: installed
  register: update

- name: Reboot if required
  win_reboot:
    post_reboot_delay: 14 # TODO: Not sure if this is required, was at 140 initially which seemed a bit excessive
  when: update.reboot_required

- name: Add override for Execution Policy for PowerShell profile
  win_shell: |
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

- name: Configure Windows optional features
  win_optional_feature:
    include_parent: yes
    name: "{{ item.name | default(item) }}"
    state: "{{ item.state | default('present') }}"
  register: optional_features
  with_items: "{{ windows_features | default([]) }}"

- name: Determine whether or not a reboot is required
  set_fact:
    needs_reboot: "{{ optional_features | json_query('results[*].reboot_required') }}"

- name: Reboot if required
  win_reboot:
    post_reboot_delay: 14 # TODO: Not sure if this is required, was at 140 initially which seemed a bit excessive
  when: needs_reboot

- name: Install git
  win_chocolatey:
    name: git
    params: /GitAndUnixToolsOnPath /WindowsTerminal /NoShellIntegration /NoCredentialManager /SChannel
    state: present

- name: Remove git start menu folder
  vars:
    shortcut_folder: Git
  include_tasks: startmenu-Windows.yml

- name: Install Bandizip
  win_chocolatey:
    name: bandizip
    state: present

- name: Move Bandizip start menu shortcut to parent folder
  vars:
    shortcut_folder: Bandizip
    shortcut_link: Bandizip
  include_tasks: startmenu-Windows.yml

- name: Install PuTTY
  win_chocolatey:
    name: putty
    state: present
