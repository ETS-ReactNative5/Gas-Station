---
- name: Ensure Megabyte Labs configuration directory exists
  file:
    mode: 0700
    path: "{{ item }}"
    state: directory
  with_items:
    - ~/.config
    - ~/.config/megabytelabs

- name: Detect previously installed Plymouth theme
  command: cat plymouth
  args:
    chdir: ~/.config/megabytelabs
  changed_when: false
  register: plymouth_theme

- name: Copy and unarchive the Plymouth theme
  unarchive:
    src: "files/plymouth-themes/{{ plymouth_theme }}.tar.gz"
    dest: "{{ plymouth_themes_dir }}"
  when: plymouth_theme.stdout != plymouth_theme

- name: Register the Plymouth theme
  alternatives:
    name: default.plymouth
    link: "{{ plymouth_themes_dir }}/default.plymouth"
    path: "{{ plymouth_themes_dir }}/{{ plymouth_theme }}/{{ plymouth_theme }}.plymouth"
    priority: 100
  when: plymouth_theme.stdout != plymouth_theme

- name: Activate the Plymouth theme # noqa 301
  command: >
    echo $(echo | sudo update-alternatives --config default.plymouth
    | grep {{ plymouth_theme }} | grep -o -E '[0-9]+' | head -1 | sed -e 's/^0\\+//')
    | sudo update-alternatives --config default.plymouth
  notify: update initramfs
  when: plymouth_theme.stdout != plymouth_theme

- name: Save information about the current Plymouth theme
  copy:
    dest: ~/.config/megabytelabs/plymouth
    mode: 0600
    content: |
      {{ plymouth_theme }}
