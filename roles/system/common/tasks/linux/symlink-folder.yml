---
- name: Create directory, if specified
  become: true
  become_user: root
  file:
    group: "{{ user.username }}"
    mode: 0740
    owner: "{{ user.username }}"
    path: "{{ item.create }}"
    recurse: true
    state: directory
  when: item.create is defined

- name: "Ensure {{ item.path }} is a directory"
  file:
    mode: 0740
    path: "{{ item.path }}"
    recurse: true
    state: directory

- name: Check if symbolic link already exists
  stat:
    path: "{{ item.link }}"
  register: sym_link

- name: Remove directory if it is not a symbolic link
  file:
    path: "{{ item.link }}"
    state: absent
  when: sym_link.stat.islnk is not defined or (sym_link.stat.islnk is defined and not sym_link.stat.islnk)

- name: Ensure symbolic link's parent directory exists
  file:
    mode: 0740
    path: "{{ item.link | dirname }}"
    recurse: true
    state: directory
  when: (item.link | dirname) != '~'

- name: Add symbolic link
  file:
    dest: "{{ item.link }}"
    mode: 0740
    src: "{{ item.path }}"
    state: link
