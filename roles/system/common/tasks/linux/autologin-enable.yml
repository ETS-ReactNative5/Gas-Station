---
- name: Register display manager path
  command: cat /etc/X11/default-display-manager
  register: display_man
  changed_when: false
  when: ansible_os_family != 'RedHat'

- name: Backup the display manager query (non-RedHat)
  set_fact:
    display_manager: "{{ display_man }}"

- name: Register display manager path (RedHat)
  command: grep '/usr/s\?bin' /etc/systemd/system/display-manager.service
  register: display_man
  changed_when: false
  when: ansible_os_family == 'RedHat'

- name: Backup the display manager query (RedHat) # noqa 503
  set_fact:
    display_manager: "{{ display_man }}"
  when: display_man.changed

- name: Set auto login user for LightDM
  blockinfile:
    path: /etc/lightdm/lightdm.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR AUTOLOGIN"
    block: |
      [Seat:*]
      autologin-user={{ autologin_user }}
      autologin-user-timeout=0
  when: "'lightdm' in display_manager.stdout"
  # @error on Fedora 35 - fatal: [workstation]: FAILED! => {"msg": "The conditional check ''lightdm' in display_manager.stdout' failed. The error was: error while evaluating conditional ('lightdm' in display_manager.stdout): 'dict object' has no attribute 'stdout'\n\nThe error appears to be in '/home/chasepowers/Playbooks/roles/system/common/tasks/linux/autologin-disable.yml': line 23, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Set auto login user for LightDM\n  ^ here\n"}

- name: Set auto-login user for GDM3
  blockinfile:
    path: /etc/gdm3/custom.conf
    insertafter: "\\[daemon]"
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR AUTOLOGIN"
    block: |
      AutomaticLoginEnable = true
      AutomaticLogin = {{ autologin_user }}
  when: "'gdm3' in display_manager.stdout and ansible_os_family != 'RedHat'"

- name: Set auto-login user for GDM
  blockinfile:
    path: /etc/gdm/custom.conf
    insertafter: "\\[daemon]"
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR AUTOLOGIN"
    block: |
      AutomaticLoginEnable = true
      AutomaticLogin = {{ autologin_user }}
  when: "'gdm' in display_manager.stdout and ansible_os_family == 'RedHat'"

- name: Set auto-login user for SDDM
  blockinfile:
    path: /etc/sddm.conf.d/autologin.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR AUTOLOGIN"
    block: |
      [Autologin]
      User={{ autologin_user }}
  when: "'sddm' in display_manager.stdout"
