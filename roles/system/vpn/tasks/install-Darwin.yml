---
- name: Register MAS installed apps
  command: mas list
  register: mas_list
  changed_when: false

- name: Ensure VPN connections are removed if configured to do so
  copy:
    src: "{{ system_connections_path }}"
    dest: "{{ system_connections_path }}.old"
    mode: preserve
  when: remove_vpn_connections | bool

- name: "Ensure {{ app_name }} is installed"
  command: "mas install '{{ wireguard_mas_id }}'"
  args:
    creates: "/Applications/WireGuard.app"
  when: (wireguard_mas_id | string) not in mas_list.stdout

- name: "Ensure {{ app_name }}'s configuration directory exists"
  file:
    path: "{{ wireguard_conf_dir }}"
    state: directory
    mode: 0600

# TODO
#- name: Copy WireGuard connection file
#  copy:
#    src: "files/vpn/{{ vpn_connection.file }}"
#    dest: "{{ wireguard_conf_dir }}/{{ vpn_connection.file | regex_replace('.nmconnection$', '.conf')  }}"
#    owner: root
#    mode: 0600
#  when: '"nmconnection" in vpn_connection.file'
# TASK [roles/system/vpn : Copy WireGuard connection file] ***********************************************************
# fatal: [workstation]: FAILED! => {"msg": "The conditional check '\"nmconnection\" in vpn_connection.file' failed. The error was: error while evaluating conditional (\"nmconnection\" in vpn_connection.file): 'vpn_connection' is undefined\n\nThe error appears to be in '/Users/bzalewski/Playbooks/roles/system/vpn/tasks/install-Darwin.yml': line 26, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Copy WireGuard connection file\n  ^ here\n"}