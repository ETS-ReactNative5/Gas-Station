---
- name: Install Wireguard NetworkManager VPN plugin dependencies
  apt:
    name:
      - build-essential
      - dh-autoreconf
      - intltool
      - libglib2.0-dev
      - libgtk-3-dev
      - libnma-dev
      - libsecret-1-dev
      - network-manager-dev
      - resolvconf
      - wireguard

- name: Clone the Wireguard NetworkManager VPN plugin git
  git:
    repo: "{{ wireguard_plugin_repo }}"
    dest: "{{ wireguard_tmp_dir }}"
    depth: "1"
    version: master

- name: Run ./autogen.sh
  command: ./autogen.sh --without-libnm-glib
  args:
    chdir: "{{ wireguard_tmp_dir }}"

- name: Run ./configure
  command: ./configure --without-libnm-glib --prefix=/usr --sysconfdir=/etc --libdir=/usr/lib/x86_64-linux-gnu --libexecdir=/usr/lib/NetworkManager --localstatedir=/var
  args:
    chdir: "{{ wireguard_tmp_dir }}"

- name: Run "make"
  command: make
  args:
    chdir: "{{ wireguard_tmp_dir }}"

- name: Run "make install"
  command: make install
  args:
    chdir: "{{ wireguard_tmp_dir }}"
  notify: restart networkmanager

- name: Remove the Wireguard temporary directory
  file:
    path: "{{ wireguard_tmp_dir }}"
    state: absent
