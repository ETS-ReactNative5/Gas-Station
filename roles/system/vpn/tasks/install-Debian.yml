---
- name: Install VPN dependencies
  apt:
    name: "{{ vpn_dependencies }}"
    state: present

- name: Remove NetworkManager's system-connections if configured to do so
  file:
    path: "{{ system_connections_path }}/"
    state: absent
  when: remove_vpn_connections | bool
  notify: restart networkmanager

- name: Check if WireGuard NetworkManager VPN plugin exists
  stat:
    path: /usr/lib/NetworkManager/nm-wireguard-service
  register: nm_wireguard

- name: Run WireGuard plugin installation, if plugin is not present
  include_tasks: wireguard-Debian.yml
  when: not nm_wireguard.stat.exists

- name: Ensure temporary directory for OpenVPN files exists # TODO Only run this if there are OpenVPN profiles in vpn_connections
  file:
    path: ~/.openvpn_tmp
    state: directory

- name: Acquire a list the current VPN connections
  command: nmcli connection show
  changed_when: false
  register: nmcli_connections

- name: Install VPN configuration files
  include_tasks: "profile-{{ ansible_os_family }}.yml"
  with_items: "{{ vpn_connections }}"

- name: Remove temporary directory for OpenVPN files # TODO Only run this if there are OpenVPN profiles in vpn_connections
  file:
    path: ~/.openvpn_tmp # TODO: Question: Is it possible to set changed_when to false for both this and the task that creates the folder after this runs?
    state: absent
