---
- name: Install VPN dependencies
  apt:
    name: "{{ vpn_dependencies }}"
    state: present

- name: Remove NetworkManager's system-connections
  file:
    path: "{{ system_connections_path }}/"
    state: absent
  when: remove_vpn_connections | bool
  notify: restart networkmanager

- name: Check if WireGuard NetworkManager VPN plugin exists
  stat:
    path: /usr/lib/NetworkManager/nm-wireguard-service
  register: nm_wireguard

- name: Run WireGuard plugin installation, if required
  include_tasks: wireguard-Debian.yml
  when: not nm_wireguard.stat.exists

- name: Copy over WireGuard configuration files
  copy:
    src: "files/wireguard/"
    dest: "{{ system_connections_path }}/"
    owner: root
    group: root
    mode: "0600"
  notify: restart networkmanager

- name: Remove previous OpenVPN files
  become: yes
  become_user: "{{ vpn_ansible_user }}"
  file:
    path: ~/.config/openvpn
    state: absent

- name: Copy OpenVPN files
  become: yes
  become_user: "{{ vpn_ansible_user }}"
  copy:
    src: "openvpn/"
    dest: "~/.config/openvpn"

- name: Acquire the current VPN connections
  command: nmcli connection show
  changed_when: false
  register: nmcli_connections

- name: Import Mullvad OpenVPN files into the Network Manager
  shell: |
    "nmcli connection import type openvpn file /home/{{ vpn_ansible_user }}/.config/openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && \
    nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_mullvad_id }}"
  loop: "{{ mullvad_profiles }}"
  when: nmcli_connections.stdout.find(item.name) != 1
  notify: restart networkmanager

- name: Modify Mullvad password files with proper permissions
  file:
    path: "/home/{{ vpn_ansible_user }}/.config/openvpn/{{ item.folder }}/mullvad_userpass.txt"
    mode: "0600"
  loop: "{{ mullvad_profiles }}"
  when: nmcli_connections.stdout.find(item.name) != 1
  notify: restart networkmanager

- name: Change password flag
  lineinfile:
    path: "{{ system_connections_path }}/{{ item.name }}.nmconnection"
    regex: "password-flags=1"
    line: password-flags=0
  loop: "{{ mullvad_profiles }}"
  notify: restart networkmanager

- name: Set password for Mullvad OpenVPN connections
  shell: |
    "nmcli connection modify '{{ item.name }}' vpn.secrets 'password={{ vault_mullvad_password }}'"
  loop: "{{ mullvad_profiles }}"
  notify: restart networkmanager

- name: Import NordVPN OpenVPN file into the Network Manager
  shell: |
    "nmcli connection import type openvpn file /home/{{ ansible_user }}/.config/openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && \
    nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_nordvpn_email }}"
  loop: "{{ nordvpn_profiles }}"
  when: nmcli_connections.stdout.find(item.name) != 1
  notify: restart networkmanager

- name: Change password flag
  lineinfile:
    path: "{{ system_connections_path }}/{{ item.name }}.nmconnection"
    regex: "password-flags=1"
    line: password-flags=0
  loop: "{{ nordvpn_profiles }}"
  notify: restart networkmanager

- name: Set password for NordVPN OpenVPN connection
  shell: "nmcli connection modify '{{ item.name }}' vpn.secrets 'password={{ nordvpn_password }}'"
  loop: "{{ nordvpn_profiles }}"
  notify: restart networkmanager

- name: Add static routes that bypass the VPN
  shell: |
    "ip route add {{ item.prefix }} via {{ item.next_hop }}"
  with_items: "{{ vpn_routes | default([]) }}"
  ignore_errors: yes