---
- name: "Ensure NetworkManager's system-connections are removed if configured to do so"
  file:
    path: "{{ system_connections_path }}/"
    state: absent
  when: remove_vpn_connections | bool
  notify: restart networkmanager

- name: "Check if WireGuard NetworkManager VPN plugin exists"
  stat:
    path: /usr/lib/NetworkManager/nm-wireguard-service
  register: nm_wireguard

- name: "Ensure WireGuard plugin is installed"
  include_tasks: nmplugin-Linux.yml
  when: not nm_wireguard.stat.exists

- name: "Ensure temporary directory for OpenVPN files exists" # TODO: Only create this if there are profiles that have not been imported
  file:
    mode: 0600
    path: "{{ openvpn_tmp_dir }}"
    state: directory
  when: vpn_connections | length

- name: "Acquire a list the current VPN connections"
  command: nmcli -t connection
  changed_when: false
  register: nmcli_connections
  when: vpn_connections | length

- name: "Ensure VPN configuration files are installed"
  include_tasks: "profile-Linux.yml"
  loop: "{{ vpn_connections | default([]) }}"
  loop_control:
    label: "{{ vpn_connection.file }}"
    loop_var: vpn_connection

# TODO Being marked as changed
- name: "Ensure temporary directory for OpenVPN files are removed"
  file:
    path: "{{ openvpn_tmp_dir }}"
    state: absent
  when: vpn_connections | length
