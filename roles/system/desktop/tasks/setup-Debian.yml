---
- name: Determine if appimaged is already installed
  command: appimaged --version
  register: appimaged_version
  changed_when: false

- debug:
    msg: "{{ appimaged_version }}"

- name: Copy appimaged.deb
  copy:
    src: appimaged.deb
    dest: ~/appimaged.deb
  when: ('built on' not in appimaged_version.stderr)

- name: Install appimaged
  apt:
    deb: ~/appimaged.deb
  when: ('built on' not in appimaged_version.stderr)

- name: Remove appimaged.deb
  file:
    path: ~/appimaged.deb
    state: absent
  when: ('built on' not in appimaged_version.stderr)

- name: Install custom desktop apt software
  apt:
    name: "{{ debian_desktop_apt_packages }}"
    state: present

- name: Remove undesirable .desktop links
  file:
    path: "{{ desktop_links_path }}/{{ item }}"
    state: absent
  with_items: "{{ gnome_shortcuts_to_delete }}"

- name: Run user-specific tasks
  include_tasks: user-Debian.yml
  loop: "{{ user_configs | default([]) }}"
  loop_control:
    label: "{{ user.username }}"
    loop_var: user
  when: not (user.system | default(false))
