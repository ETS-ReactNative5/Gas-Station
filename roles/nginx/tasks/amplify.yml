---
- name: Add APT NGINX signing key
  apt_key:
    url: https://nginx.org/keys/nginx_signing.key

- name: Install NGINX Amplify dependencies
  apt:
    name:
      - apt-transport-https
      - python-apt
    state: present

- name: Add NGINX Amplify agent repository (64-bit Non-Focal)
  vars:
    ansible_python_interpreter: /usr/bin/python2
  apt_repository:
    filename: nginx-amplify
    repo: deb [arch=amd64] http://HTTPS///packages.amplify.nginx.com/{{ ansible_distribution | lower }}/ {{ ansible_distribution_release | lower }} amplify-agent
  when: ansible_distribution_release != 'focal'

- name: Add NGINX Amplify agent repository (AMD 64-bit Focal)
  vars:
    ansible_python_interpreter: /usr/bin/python2
  apt_repository:
    filename: nginx-amplify
    repo: deb [arch=amd64] http://HTTPS///packages.amplify.nginx.com/py3/ubuntu/ focal amplify-agent
  when:
    - ansible_distribution_release == 'focal'
    - ansible_architecture == 'x86_64'

- name: Add NGINX Amplify agent repository (Raspberry Pi/Other)
  vars:
    ansible_python_interpreter: /usr/bin/python2
  apt_repository:
    filename: nginx-amplify
    repo: deb http://HTTPS///packages.amplify.nginx.com/ubuntu/ focal amplify-agent
  when:
    - ansible_distribution_release == 'focal'
    - ansible_architecture != 'x86_64'

- name: Install nginx-amplify-agent
  apt:
    name: nginx-amplify-agent
    state: present

- name: Copy NGINX Amplify agent configuration
  copy:
    remote_src: yes
    src: /etc/amplify-agent/agent.conf.default
    dest: /etc/amplify-agent/agent.conf

- name: Inject the NGINX Amplify agent API key into the configuration
  lineinfile:
    dest: /etc/amplify-agent/agent.conf
    regexp: api_key =.*
    line: "api_key = {{ nginx_amplify_api_key }}"

- name: Start NGINX Amplify agent
  service:
    name: amplify-agent
    state: started
