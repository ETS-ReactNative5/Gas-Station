---
- name: Install Brotli apt dependencies
  apt:
    name:
      - cmake
      - gcc
      - libpcre3
      - libpcre3-dev
      - libssl-dev
      - zlib1g
      - zlib1g-dev
    state: present

- name: "Download and unarchive NGINX source code of version {{ nginx_version }}"
  unarchive:
    src: "https://nginx.org/download/nginx-{{ nginx_version }}.tar.gz"
    dest: ~/
    remote_src: yes

- name: Git clone Brotli module (google/ngx_brotli)
  git:
    repo: https://github.com/google/ngx_brotli.git
    dest: ~/ngx_brotli

- name: Configure Brotli module
  command:
    chdir: "~/nginx-{{ nginx_version }}"
    cmd: ./configure --with-compat --add-dynamic-module=../ngx_brotli

- name: Make Brotli modules
  make:
    chdir: "~/nginx-{{ nginx_version }}"
    target: modules

- name: Copy compiled Brotli module to /usr/share/nginx/modules
  copy: 
    remote_src: yes
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "644"
  with_items:
    - src: "~/nginx-{{ nginx_version }}/objs/ngx_http_brotli_filter_module.so"
      dest: "/usr/share/nginx/modules"
    - src: "~/nginx-{{ nginx_version }}/objs/ngx_http_brotli_static_module.so"
      dest: "/usr/share/nginx/modules"

- name: Delete unnecessary directories
  file:
    state: absent
    path: "{{ item }}"
  with_items:
    - ~/ngx_brotli
    - "~/nginx-{{ nginx_version }}"
