---
- name: Include variables based on OS Family 
  include_vars: "{{ ansible_os_family }}.yml"

- name: Include tasks based on OS Family
  become: yes
  include_tasks: "install-{{ ansible_os_family }}.yml"

- name: Clear all sites-enabled symlinks if configured to do so
  become: yes
  file:
    path: /etc/nginx/sites-enabled/*
    state: absent
  when: nginx_clear_sites_enabled

- name: Install NGINX on Debian system
  include_tasks: install-debian.yml
  when:
    - ansible_os_family == 'Debian'
    - not refresh_nginx_config_only

- name: Check if dhparam.pem exists
  stat:
    path: /etc/ssl/certs/dhparam.pem
  register: dhparam_pem

- name: Ensure dhparam.pem exists
  include_tasks: dhparam.yml
  when:
    - not refresh_nginx_config_only
    - not dhparam_pem.stat.exists

- name: Update NGINX configuration
  include_tasks: nginx-configuration.yml
  when: not refresh_nginx_config_only

- name: Remove NGINX Amplify stub_status.conf if nginx_amplify_api_key is not provided
  become: yes
  file:
    path: /etc/nginx/conf.d/stub_status.conf
    state: absent
  when:
    - nginx_amplify_api_key is undefined
    - not refresh_nginx_config_only

- name: Remove Brotli config files if Brotli not enabled
  become: yes
  file:
    path: "{{ item }}"
    state: absent
  when:
    - not enable_brotli_modules
    - not refresh_nginx_config_only
  with_items:
    - /etc/nginx/conf.d/brotli.conf
    - /etc/nginx/modules-enabled/50-mod-brotli.conf

- name: Remove ModSecurity config files if ModSecurity is not enabled
  become: yes
  file:
    path: /etc/nginx/modules-enabled/50-mod-security.conf
    state: absent
  when:
    - not enable_modsecurity_waf
    - not refresh_nginx_config_only

- name: Update the NGINX configuration files
  include_tasks: nginx-configuration.yml
  when: refresh_nginx_config_only

- name: Kill any processes that might be running on port 80 or 443
  shell: kill $(lsof -ti:80 -sTCP:LISTEN) && kill $(lsof -ti:443 -sTCP:LISTEN)
  ignore_errors: yes

- name: Reload systemctl
  systemd:
    daemon_reload: yes
    name: nginx
    state: restarted
