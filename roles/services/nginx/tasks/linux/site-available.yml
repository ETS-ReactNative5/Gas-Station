---
- name: "Register {{ host_id }}'s template variables"
  set_fact:
    app_authelia: "{{ item.authelia | default(hosts[host_id].authelia | default(true)) }}"
    app_default_server: "{{ item.default_server | default(hosts[host_id].default_server | default(false)) }}"
    app_firewall: "{{ item.firewall | default(hosts[host_id].firewall | default(false)) }}"
    app_fqdn: "{{ item.fqdn | default(hosts[host_id].fqdn | default(hosts[host_id].hosts.split()[-1])) }}"
    app_http_hosts: "{{ hosts[host_id].hosts }}"
    app_id: "{{ host_id }}"
    app_intercept_errors: "{{ item.intercept_errors | default(hosts[host_id].intercept_errors | default(true)) }}"
    app_letsencrypt_domain: "{{ item.letsencrypt_domain | default(hosts[host_id].letsencrypt_domain | default(base_domain)) }}"
    app_nginx_serve_http: "{{ nginx_serve_http | default(true) }}"
    app_proxy_certificate: "{{ item.certificate | default(false) }}"
    app_proxy_certificate_key: "{{ item.certificate_key | default(false) }}"
    app_proxy_certificate_trusted: "{{ item.certificate_trusted | default(false) }}"
    app_proxy_file: "{{ hosts[host_id].proxy_file | default('proxy.conf') }}"
    app_proxy_pass_port: "{{ item.proxy_pass_port | default(hosts[host_id].proxy_pass_port | default(ports[host_id])) }}"
    app_proxy_pass_url: "{{ item.proxy_pass_url | default(host_id) }}"
    app_ssl_trusted_certificate: "{{ item.ssl_trusted_certificate | default(false) }}"
    app_theme_url: "{{ item.theme_url | default(hosts[host_id].theme_url | default(false)) }}"
    app_transport: "{{ item.transport | default(hosts[host_id].transport | default('http')) }}"
    app_waf_rules: "{{ hosts[host_id].custom_waf_rules | default(false) }}"
    app_with_authelia: "{{ nginx_hosting_authelia | default(false) }}"

- name: "Generate NGINX configuration file for {{ host_id }}"
  template:
    src: site-available.conf.j2
    dest: "/etc/nginx/sites-available/{{ host_id }}.conf"
    owner: root
    group: root
    mode: "644"
