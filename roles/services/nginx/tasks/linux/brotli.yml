---
- name: Install Brotli apt dependencies
  apt:
    name: "{{ brotli_dependencies }}"
    state: present

- name: "Download and unarchive NGINX source code of version {{ nginx_version }}"
  unarchive:
    src: "https://nginx.org/download/nginx-{{ nginx_version }}.tar.gz"
    dest: ~/
    remote_src: true

- name: Git clone Brotli module (google/ngx_brotli)
  git:
    repo: "{{ brotli_git_repository }}"
    dest: ~/ngx_brotli

- name: Configure Brotli module
  command:
    chdir: "~/nginx-{{ nginx_version }}"
    cmd: ./configure --with-compat --add-dynamic-module=../ngx_brotli

- name: Make Brotli modules
  make:
    chdir: "~/nginx-{{ nginx_version }}"
    target: modules

- name: Copy compiled Brotli module to /usr/share/nginx/modules
  copy:
    remote_src: true
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "644"
  with_items:
    - src: "~/nginx-{{ nginx_version }}/objs/ngx_http_brotli_filter_module.so"
      dest: "/usr/share/nginx/modules"
    - src: "~/nginx-{{ nginx_version }}/objs/ngx_http_brotli_static_module.so"
      dest: "/usr/share/nginx/modules"

- name: Delete unnecessary directories
  file:
    state: absent
    path: "{{ item }}"
  with_items:
    - ~/ngx_brotli
    - "~/nginx-{{ nginx_version }}"
