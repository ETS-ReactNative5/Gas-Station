---
- name: Install NGINX Optimized base dependencies
  apt:
    name: "{{ nginx_dependencies }}"
    state: present

- name: Gather the apt package facts
  package_facts:
    manager: auto

- name: Set a variable equal to the NGINX version
  set_fact:
    nginx_version: "{{ ansible_facts.packages['nginx'][0].version | regex_search('^[0-9.]*') }}"

- name: Add styled status code response pages from Git repository
  include_tasks: linux/status-pages.yml

- name: Modify the NGINX service to prevent failures on start up when /etc/hosts is not loaded quickly enough
  lineinfile:
    path: "{{ nginx_service_path }}"
    regexp: "After=network.target"
    line: After=network-online.target
    owner: root
    group: root
    mode: '0644'

- name: Register file details of the Brotli compression module
  stat:
    path: "{{ nginx_module_path }}/ngx_http_brotli_static_module.so"
  register: brotli_stat

- name: Compile Brotli modules
  include_tasks: linux/brotli.yml
  when:
    - enable_nginx_brotli
    - not brotli_stat.stat.exists

- name: Register file information for dhparam.pem
  stat:
    path: "{{ dhparam_path }}"
  register: dhparam_pem

- name: Ensure dhparam.pem exists
  include_tasks: linux/dhparam.yml
  when: not dhparam_pem.stat.exists

- name: Install NGINX Amplify
  include_tasks: linux/amplify.yml
  when:
    - nginx_amplify_api_key is defined
    - enable_nginx_amplify

- name: Register the file status of the ModSecurity WAF module configuration file
  stat:
    path: "{{ modsec_waf_conf_directory }}/crs-setup.conf"
  register: modsec_config

- name: Compile ModSecurity WAF module
  include_tasks: linux/modsecurity.yml
  when:
    - enable_nginx_modsecurity_waf
    - not modsec_config.stat.exists

- name: Set up wildcard SSL automatically with CloudFlare
  include_tasks: linux/certbot.yml
  when: cloudflare_api_token is defined

- name: Update the NGINX configuration files
  include_tasks: linux/nginx-configuration.yml
  tags: nginx_configuration

- name: Generate sites-available
  include_tasks: linux/site-available.yml
  with_items: "{{ nginx_sites }}"
  tags: nginx_configuration

- name: Generate sites-available for proxy host
  vars:
    nginx_proxy_host_override: yes
  include_tasks: linux/site-available.yml
  with_items: "{{ hosts | list }}"
  when:
    - nginx_proxy_host
    - not (item in apps)

- name: Symlink sites-enabled
  file:
    src: "/etc/nginx/sites-available/{{ item | default(item.name) }}.conf"
    path: "/etc/nginx/sites-enabled/{{ item | default(item.name) }}.conf"
    state: link
  with_items: "{{ nginx_sites }}"
  tags: nginx_configuration

- name: Reload systemd and restart NGINX
  systemd:
    daemon_reload: yes
    name: nginx
    state: restarted
  tags: nginx_configuration
