---
- name: Check if the Documents folder already has a folder with the rclone configuration's name
  become: true
  become_user: "{{ user.username }}"
  stat:
    path: "~/Documents/{{ item.name }}"
  register: document_link

- name: Add symlink to Cloud provider
  become: true
  become_user: "{{ user.username }}"
  file:
    src: "/mnt/{{ item.provider }}"
    dest: "~/Documents/{{ item.name }}"
    owner: "{{ user.username }}"
    group: "{{ user.username }}"
    state: link
    force: true
  when: not document_link.stat.exists

- name: Check provider folder information
  stat:
    path: "/mnt/{{ item.provider }}"
  register: provider_folder

- name: Ensure provider has folder created
  become: true
  file:
    path: "/mnt/{{ item.provider }}"
    owner: "{{ user.username }}"
    group: "{{ user.username }}"
    state: directory
    mode: "700"
  when: not provider_folder.stat.exists

- name: Install rclone mount services
  become: true
  template:
    src: rclone.service.j2
    dest: "{{ service_path }}/{{ item.provider }}-rclone.service"
    owner: root
    group: root
    mode: "644"

- name: Start the rclone services # TODO: Make this work on systems other than Ubuntu (systems without systemd)
  become: true
  systemd:
    name: "{{ item.provider }}-rclone.service"
    state: started
    enabled: true
