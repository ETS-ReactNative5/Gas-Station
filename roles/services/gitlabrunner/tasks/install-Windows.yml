---
- name: "Ensure {{ app_name }} is installed"
  chocolatey.chocolatey.win_chocolatey:
    name: gitlab-runner
    state: "{{ app_state | default('present') }}"
    package_params: /Service /InstallDir:"{{ gitlab_runner_path }}"

- name: Ensure Megabyte Labs configuration directory exists
  ansible.windows.win_file:
    path: "{{ item }}"
    state: directory
  loop:
    - '%USERPROFILE%\.config'
    - '%USERPROFILE%\.config\megabytelabs'

- name: "Check if {{ app_name }} has configuration stored in '%USERPROFILE%/.config/megabytelabs/gitlabrunner'"
  ansible.windows.win_stat:
    path: '%USERPROFILE%\.config\megabytelabs\gitlabrunner'
  register: gitlabrunner_config

- name: "Ensure {{ app_name }} is registered" # noqa 503
  ansible.windows.win_command: gitlab-runner.exe register \
    --non-interactive \
    --url "{{ gitlab_url }}" \
    --registration-token "{{ gitlab_registration_token }}" \
    --executor "{{ gitlab_runner_executor }}" \
    --docker-image "{{ gitlab_runner_image }}" \
    --description "{{ gitlab_runner_description }}" \
    --tag-list "{{ gitlab_runner_tags }}"
  args:
    chdir: "{{ gitlab_runner_path }}"
  register: gitlab_runner_registration
  when:
    - (not gitlabrunner_config.stat.exists)
    - register_runner

- name: "Save meta information about the version of {{ app_name }} that was installed"
  ansible.windows.win_file:
    path: '%USERPROFILE%\.config\megabytelabs\gitlabrunner'
    state: touch
  when: gitlab_runner_registration.changed
