---
- name: Ensure MongoDB's dependencies are installed
  dnf:
    name: "{{ mongodb_dependencies }}"
    state: "{{ app_state | default('present') }}"
    update_cache: true
# fatal: [workstation]: FAILED! => {"changed": false, "connection": "close", "content": "<html>\n<head><title>404 Not Found</title></head>\n<body>\n<h1>404 Not Found</h1>\n<ul>\n<li>Code: NoSuchKey</li>\n<li>Message: The specified key does not exist.</li>\n<li>Key: yum/redhat/35/mongodb-org/4.4/x86_64/RPMS/index.html</li>\n<li>RequestId: 3TFC54S22PDV71MP</li>\n<li>HostId: LtWwwAD1qIquc3wwMai4zneFq4er7CsL57hBDoy1tq7J9Ts1LDQ/eTNgA4Esa+wIjheV3PkmNDM=</li>\n</ul>\n<hr/>\n</body>\n</html>\n", "content_length": "387", "content_type": "text/html; charset=utf-8", "date": "Mon, 06 Dec 2021 02:05:51 GMT", "elapsed": 0, "msg": "Status code was 404 and not [200]: HTTP Error 404: Not Found", "redirected": false, "server": "AmazonS3", "status": 404, "url": "http://repo.mongodb.org/yum/redhat/35/mongodb-org/4.4/x86_64/RPMS/", "via": "1.1 784a91ee0539c02263f0e03f7760900c.cloudfront.net (CloudFront)", "x_amz_cf_id": "f9FmB9tPqLdw_olg-SPqY8TTu-ejNGZrWe620ryZFSEo4fIUe5iWNA==", "x_amz_cf_pop": "EWR52-C2", "x_cache": "Error from cloudfront"}
- name: Find the latest version of MongoDB package
  uri:
    url: "http://repo.mongodb.org/yum/redhat/{{ ansible_distribution_major_version }}/mongodb-org/{{ mongodb_version }}/x86_64/RPMS/"
    return_content: true
  register: mongodb_versions

- name: Save the name of MongoDB RPM file to a variable
  set_fact:
    mongodb_rpm: "{{ mongodb_versions.content | regex_findall('mongodb-org-server-[(\\d\\.)*\\d*-el\\d\\.]*x86_64\\.rpm') | last }}"

- name: Ensure MongoDB is installed
  dnf:
    name: "http://repo.mongodb.org/yum/redhat/{{ ansible_distribution_major_version }}/mongodb-org/{{ mongodb_version }}/x86_64/RPMS/{{ mongodb_rpm }}"
    state: present

- name: Run generic Linux tasks
  include_tasks: install-Linux.yml
