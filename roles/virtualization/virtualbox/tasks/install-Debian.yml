---
- name: "Add {{ app_name }}'s apt key"
  apt_key:
    state: present
    url: "{{ virtualbox_apt_key }}"

- name: "Add {{ app_name }}'s apt repository"
  apt_repository:
    filename: virtualbox
    repo: "{{ virtualbox_apt_repository }}"
    state: present
    update_cache: true

- name: "Ensure {{ app_name }} is installed"
  apt:
    name: "{{ vbox_package_name }}"
    state: present
  register: install_result

- name: "Ensure {{ app_name }} Extension pack is installed"
  block:
    - name: "Ensure {{ app_name }} Extension pack directory exists"
      file:
        path: "/usr/lib/virtualbox/ExtensionPacks/Oracle_VM_VirtualBox_Extension_Pack/"
        state: directory
        mode: 0744
        owner: root
        group: root
    - name: "Ensure {{ app_name }} Extension pack installer is downloaded and up-to-date"
      get_url:
        url: "{{ 'https://download.virtualbox.org/virtualbox/' + vbox_version + '/Oracle_VM_VirtualBox_Extension_Pack-' + vbox_version + '.vbox-extpack' }}"
        dest: "/usr/lib/virtualbox/ExtensionPacks/Oracle_VM_VirtualBox_Extension_Pack.vbox-extpack"
    - name: "Ensure {{ app_name }} Extension pack is installed" # noqa 303
      become: false
      shell: |
        set -o pipefail
        echo 'y' | sudo VBoxManage extpack install --replace /usr/lib/virtualbox/ExtensionPacks/Oracle_VM_VirtualBox_Extension_Pack.vbox-extpack
      args:
        creates: /usr/lib/virtualbox/ExtensionPacks/Oracle_VM_VirtualBox_Extension_Pack/
  when: install_result.changed
  always:
    - name: "Remove {{ app_name }} Extension pack installer"
      file:
        path: "/usr/lib/virtualbox/ExtensionPacks/Oracle_VM_VirtualBox_Extension_Pack.vbox-extpack"
        state: absent
