---
- name: Check if VHDX already exists
  win_stat:
    path: "{{ hyperv_vhdx_dest }}"
  register: vhdx_file

- name: Provision VM
  block:
    - name: Create the VM if it does not exist
      win_hyperv_guest:
        name: "{{ hyperv_vm_name }}"
        generation: 2
        cpu: "{{ hyperv_vm_cpu }}"
        memory: "{{ hyperv_vm_memory }}"
        network_switch: "{{ hyperv_vm_network_switch }}"
        diskpath: "{{ hyperv_vhdx_dest }}"
        state: present

    - name: Configure VM's NIC
      win_hyperv_guest_config_net:
        name: "{{ hyperv_vm_name }}"
        ip: "{{ hyperv_vm_ip }}"
        netmask: "{{ hyperv_vm_netmask }}"
        gateway: "{{ hyperv_vm_gateway }}"
        dns: "{{ hyperv_vm_dns }}"
        type: static

    - name: Add virtual machine to playbook inventory
      add_host:
        name: "{{ hyperv_vm_name }}"
        ansible_connection: "{{ hyperv_vm_connection }}"
        ansible_host: "{{ hyperv_vm_ip }}"
        groups: "{{ hyperv_vm_groups }}"

    - name: Power on VM (Windows)
      win_wait_for:
        host: "{{ hyperv_vm_ip }}"
        port: "{{ hyperv_vm_ansible_port }}"
        timeout: 300
  when: not vhdx_file.stdout.stat.exists