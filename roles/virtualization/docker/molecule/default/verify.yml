---
- name: Verify
  hosts: all
  gather_facts: true

  tasks:
    - name: Checking Windows targets
      block:
        - name: Create temporary directory in $HOME
          win_file:
            path: "{{ lookup('env', 'HOME') }}/tmp"
            state: present

        - name: Check docker-compose version (non-Windows)
          command: export TMPDIR=$HOME/tmp && docker-compose --version
          register: docker_compose_version
          changed_when: false
          failed_when: false

        - name: Check docker version (non-Windows)
          command: |
            docker --version
          register: docker_version
          changed_when: false
          failed_when: false
      when:
        - ansible_os_family != 'Windows'

    - name: Checking Windows targets
      block:
        - name: Check docker-compose version (Windows)
          win_command: docker-compose --version
          register: docker_compose_version
          changed_when: false
          failed_when: false

        - name: Check docker-compose version (Windows)
          win_command: docker --version
          register: docker_version
          changed_when: false
          failed_when: false
      when:
        - ansible_os_family == 'Windows'

    - name: Assertion for Docker
      assert:
        that: '"Docker version " in docker_version.stdout'

    - name: Assertion for docker-compose
      assert:
        that: '"docker-compose version " in docker_compose_version.stdout'
