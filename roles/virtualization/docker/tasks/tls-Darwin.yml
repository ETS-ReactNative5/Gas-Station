---
- name: Run common Darwin/Linux tasks
  include_tasks: tls-Darwin-Linux.yml

- name: Add certificate to keystore
  become: yes
  shell: |
    cd "/Users/{{ ansible_user }}/.docker/certs.d"
    security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ca.pem

- name: Create daemon.json
  shell: |
    echo "{
    hosts = "tcp://0.0.0.0:2376";
    tlsverify = $true;
    tlscacert = "/Users/{{ ansible_user }}/.docker/certs.d/ca.pem";
    tlscert = "/Users/{{ ansible_user }}/.docker/certs.d/docker-server-cert.pem";
    tlskey = "/Users/{{ ansible_user }}/.docker/certs.d/docker-server-key.pem"
    }" > /Users/{{ ansible_user }}/.docker/daemon.json

- name: Copy certificates to the ~/.docker folder on the machine running Ansible
  fetch:
    src: "~/.docker/certs.d/{{ item }}"
    dest: "~/.docker/certs.d/{{ ansible_host }}-{{ item }}"
    mode: "400"
    flat: yes
  with_items:
    - ca.pem
    - cert.pem
    - key.pem
  when: ansible_host != 'local'

- name: Restart the Docker Desktop app
  shell: osascript -e 'quit app "Docker"'; open --background -a Docker
