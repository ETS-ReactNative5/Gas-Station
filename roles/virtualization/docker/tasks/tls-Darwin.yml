---
- name: Run common Darwin/Linux tasks
  include_tasks: tls-Darwin-Linux.yml

- name: Add certificate to keystore
  become: true
  command: security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ca.pem
  args:
    chdir: "/Users/{{ ansible_user }}/.docker/certs.d"

- name: Create daemon.json
  template:
    src: daemon.json.j2 # TODO: This JSON file is not formatted like regular JSON - is this on purpose?
    dest: "/Users/{{ ansible_user }}/.docker/daemon.json"
    owner: "{{ user.username }}"
    group: "{{ user.username }}"
    mode: "600" # TODO: Is this the right permission level?

- name: Copy certificates to the ~/.docker folder on the machine running Ansible
  fetch:
    src: "~/.docker/certs.d/{{ item }}"
    dest: "~/.docker/certs.d/{{ ansible_host }}-{{ item }}"
    mode: "400"
    flat: true
  with_items:
    - ca.pem
    - cert.pem
    - key.pem
  when: ansible_host != 'local'

- name: Restart the Docker Desktop app
  shell: osascript -e 'quit app "Docker"'; open --background -a Docker
  args:
    warn: no
