---
- name: Setup VMware Workstation facts
  set_fact:
    workstation_extra_packages: "{{ os_workstation_extra_packages }}"
  when:
    - workstation_extra_packages is undefined
    - os_workstation_extra_packages is defined

- name: Create temporary directory
  file:
    path: "{{ workstation_tempdir }}"
    state: directory
    mode: 0755

- name: Check for pre-downloaded binary
  stat:
    path: "{{ workstation_tempdir }}/tryworkstation-linux-64.sh"
  register: file_stats

- name: Download workstation # noqa 303
  command: |
    curl -LA "Mozilla/5.0 (X11; Linux x86_64; rv:82.0) Gecko/20210101 Firefox/82.0" "{{ workstation_download_url }}" \
      -o "{{ workstation_tempdir }}/tryworkstation-linux-64.sh"
  args:
    creates: "{{ workstation_tempdir }}/tryworkstation-linux-64.sh"
  when: not file_stats.stat.exists

- name: Ensure Workstation installer is executable
  file:
    path: "{{ workstation_tempdir }}/tryworkstation-linux-64.sh"
    mode: 0755

- name: Run installer
  become: true
  command: >
    {{ workstation_tempdir }}/tryworkstation-linux-64.sh --eulas-agreed --console
    --required {{ '--set-setting vmware-workstation serialNumber ' + workstation_license
    if workstation_license is defined else '' }}
  args:
    creates: /usr/bin/vmware
  tags:
    - skip_ansible_lint

- name: Install packages needed by VMWare Packer build
  become: true
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ workstation_extra_packages }}"
  when: workstation_extra_packages is defined

- name: Stat for systemd
  stat:
    path: /etc/systemd/system
  register: systemd_dir

- name: Install systemd services
  copy:
    src: "{{ item }}"
    dest: /etc/systemd/system/
    owner: root
    mode: 0644
  loop:
    - vmware.service
    - vmware-usbarbitrator.service
    - vmware-workstation-server.service
  notify: reload systemd configurations
  when: systemd_dir.stat.exists

- name: Clone Unlocker (for running Mac OS X on VMWare)
  git:
    depth: "1"
    dest: "{{ unlocker_temp_dir }}"
    force: true
    repo: "{{ unlocker_git }}"
    version: master

- name: Update python to python3 in lnx-install.sh
  lineinfile:
    path: "{{ unlocker_temp_dir }}/lnx-install.sh"
    regex: "python gettools.py"
    line: python3 gettools.py

# @error - TASK [roles/virtualization/vmware : Patch VMWare for Mac OS X] *****************
# fatal: [workstation]: FAILED! => {"changed": true, "cmd": ["bash", "lnx-install.sh"], "delta": "0:00:00.729263", "end": "2021-12-05 20:11:48.081325", "msg": "non-zero return code", "rc": 1, "start": "2021-12-05 20:11:47.352062", "stderr": "Traceback (most recent call last):\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 1348, in do_open\n    h.request(req.get_method(), req.selector, req.data, headers,\n  File \"/usr/lib64/python3.10/http/client.py\", line 1276, in request\n    self._send_request(method, url, body, headers, encode_chunked)\n  File \"/usr/lib64/python3.10/http/client.py\", line 1322, in _send_request\n    self.endheaders(body, encode_chunked=encode_chunked)\n  File \"/usr/lib64/python3.10/http/client.py\", line 1271, in endheaders\n    self._send_output(message_body, encode_chunked=encode_chunked)\n  File \"/usr/lib64/python3.10/http/client.py\", line 1031, in _send_output\n    self.send(msg)\n  File \"/usr/lib64/python3.10/http/client.py\", line 969, in send\n    self.connect()\n  File \"/usr/lib64/python3.10/http/client.py\", line 940, in connect\n    self.sock = self._create_connection(\n  File \"/usr/lib64/python3.10/socket.py\", line 824, in create_connection\n    for res in getaddrinfo(host, port, 0, SOCK_STREAM):\n  File \"/usr/lib64/python3.10/socket.py\", line 955, in getaddrinfo\n    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):\nsocket.gaierror: [Errno -2] Name or service not known\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/tmp/unlocker/gettools.py\", line 225, in <module>\n    main()\n  File \"/tmp/unlocker/gettools.py\", line 113, in main\n    response = urlopen(url)\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 216, in urlopen\n    return opener.open(url, data, timeout)\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 519, in open\n    response = self._open(req, data)\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 536, in _open\n    result = self._call_chain(self.handle_open, protocol, protocol +\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 496, in _call_chain\n    result = func(*args)\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 1377, in http_open\n    return self.do_open(http.client.HTTPConnection, req)\n  File \"/usr/lib64/python3.10/urllib/request.py\", line 1351, in do_open\n    raise URLError(err)\nurllib.error.URLError: <urlopen error [Errno -2] Name or service not known>", "stderr_lines": ["Traceback (most recent call last):", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 1348, in do_open", "    h.request(req.get_method(), req.selector, req.data, headers,", "  File \"/usr/lib64/python3.10/http/client.py\", line 1276, in request", "    self._send_request(method, url, body, headers, encode_chunked)", "  File \"/usr/lib64/python3.10/http/client.py\", line 1322, in _send_request", "    self.endheaders(body, encode_chunked=encode_chunked)", "  File \"/usr/lib64/python3.10/http/client.py\", line 1271, in endheaders", "    self._send_output(message_body, encode_chunked=encode_chunked)", "  File \"/usr/lib64/python3.10/http/client.py\", line 1031, in _send_output", "    self.send(msg)", "  File \"/usr/lib64/python3.10/http/client.py\", line 969, in send", "    self.connect()", "  File \"/usr/lib64/python3.10/http/client.py\", line 940, in connect", "    self.sock = self._create_connection(", "  File \"/usr/lib64/python3.10/socket.py\", line 824, in create_connection", "    for res in getaddrinfo(host, port, 0, SOCK_STREAM):", "  File \"/usr/lib64/python3.10/socket.py\", line 955, in getaddrinfo", "    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):", "socket.gaierror: [Errno -2] Name or service not known", "", "During handling of the above exception, another exception occurred:", "", "Traceback (most recent call last):", "  File \"/tmp/unlocker/gettools.py\", line 225, in <module>", "    main()", "  File \"/tmp/unlocker/gettools.py\", line 113, in main", "    response = urlopen(url)", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 216, in urlopen", "    return opener.open(url, data, timeout)", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 519, in open", "    response = self._open(req, data)", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 536, in _open", "    result = self._call_chain(self.handle_open, protocol, protocol +", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 496, in _call_chain", "    result = func(*args)", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 1377, in http_open", "    return self.do_open(http.client.HTTPConnection, req)", "  File \"/usr/lib64/python3.10/urllib/request.py\", line 1351, in do_open", "    raise URLError(err)", "urllib.error.URLError: <urlopen error [Errno -2] Name or service not known>"], "stdout": "Unlocker 3.0.2 for VMware Workstation\n=====================================\n(c) Dave Parsons 2011-18\nCreating backup folder...\n'/usr/lib/vmware/bin/vmware-vmx' -> './backup/vmware-vmx'\n'/usr/lib/vmware/bin/vmware-vmx-debug' -> './backup/vmware-vmx-debug'\n'/usr/lib/vmware/bin/vmware-vmx-stats' -> './backup/vmware-vmx-stats'\n'/usr/lib/vmware/lib/libvmwarebase.so/libvmwarebase.so' -> './backup/libvmwarebase.so'\nPatching...\nFile: /usr/lib/vmware/bin/vmware-vmx\n\nappleSMCTableV0 (smc.version = \"0\")\nappleSMCTableV0 Address      : 0x11503c0\nappleSMCTableV0 Private Key #: 0xF2/242\nappleSMCTableV0 Public Key  #: 0xF0/240\nappleSMCTableV0 Table        : 0x11503e0\n+LKS Key: \n002 0x1150428 +LKS 01 flag 0x90 0x227ae0 07 \nOSK0 Key Before:\n241 0x1154760 OSK0 32 ch8* 0x80 0x227b50 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK0 Key After:\n241 0x1154760 OSK0 32 ch8* 0x80 0x227ae0 6F 75 72 68 61 72 64 77 6F 72 6B 62 79 74 68 65 73 65 77 6F 72 64 73 67 75 61 72 64 65 64 70 6C \nOSK1 Key Before:\n242 0x11547a8 OSK1 32 ch8* 0x80 0x227b50 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK1 Key After:\n242 0x11547a8 OSK1 32 ch8* 0x80 0x227ae0 65 61 73 65 64 6F 6E 74 73 74 65 61 6C 28 63 29 41 70 70 6C 65 43 6F 6D 70 75 74 65 72 49 6E 63 \n\nappleSMCTableV1 (smc.version = \"1\")\nappleSMCTableV1 Address      : 0x11547f0\nappleSMCTableV1 Private Key #: 0x01B4/436\nappleSMCTableV1 Public Key  #: 0x01B0/432\nappleSMCTableV1 Table        : 0x1154820\n+LKS Key: \n004 0x11548f8 +LKS 01 flag 0x90 0x227ae0 01 \nOSK0 Key Before:\n435 0x115c230 OSK0 32 ch8* 0x90 0x227b50 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK0 Key After:\n435 0x115c230 OSK0 32 ch8* 0x90 0x227ae0 6F 75 72 68 61 72 64 77 6F 72 6B 62 79 74 68 65 73 65 77 6F 72 64 73 67 75 61 72 64 65 64 70 6C \nOSK1 Key Before:\n436 0x115c278 OSK1 32 ch8* 0x90 0x227b50 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK1 Key After:\n436 0x115c278 OSK1 32 ch8* 0x90 0x227ae0 65 61 73 65 64 6F 6E 74 73 74 65 61 6C 28 63 29 41 70 70 6C 65 43 6F 6D 70 75 74 65 72 49 6E 63 \n\nModifying RELA records from: 0x227b50 to 0x227ae0\ne_shoff: 0x16b7880 e_shentsize: 0x40 e_shnum:0x29 e_shstrndx:0x28\nRelocation modified at: 0xf4b30\nRelocation modified at: 0xf4b48\nRelocation modified at: 0xf7428\nRelocation modified at: 0xf7440\nFile: /usr/lib/vmware/bin/vmware-vmx-debug\n\nappleSMCTableV0 (smc.version = \"0\")\nappleSMCTableV0 Address      : 0x154e300\nappleSMCTableV0 Private Key #: 0xF2/242\nappleSMCTableV0 Public Key  #: 0xF0/240\nappleSMCTableV0 Table        : 0x154e320\n+LKS Key: \n002 0x154e368 +LKS 01 flag 0x90 0x2853c0 07 \nOSK0 Key Before:\n241 0x15526a0 OSK0 32 ch8* 0x80 0x285570 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK0 Key After:\n241 0x15526a0 OSK0 32 ch8* 0x80 0x2853c0 6F 75 72 68 61 72 64 77 6F 72 6B 62 79 74 68 65 73 65 77 6F 72 64 73 67 75 61 72 64 65 64 70 6C \nOSK1 Key Before:\n242 0x15526e8 OSK1 32 ch8* 0x80 0x285570 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK1 Key After:\n242 0x15526e8 OSK1 32 ch8* 0x80 0x2853c0 65 61 73 65 64 6F 6E 74 73 74 65 61 6C 28 63 29 41 70 70 6C 65 43 6F 6D 70 75 74 65 72 49 6E 63 \n\nappleSMCTableV1 (smc.version = \"1\")\nappleSMCTableV1 Address      : 0x1552730\nappleSMCTableV1 Private Key #: 0x01B4/436\nappleSMCTableV1 Public Key  #: 0x01B0/432\nappleSMCTableV1 Table        : 0x1552760\n+LKS Key: \n004 0x1552838 +LKS 01 flag 0x90 0x2853c0 01 \nOSK0 Key Before:\n435 0x155a170 OSK0 32 ch8* 0x90 0x285570 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK0 Key After:\n435 0x155a170 OSK0 32 ch8* 0x90 0x2853c0 6F 75 72 68 61 72 64 77 6F 72 6B 62 79 74 68 65 73 65 77 6F 72 64 73 67 75 61 72 64 65 64 70 6C \nOSK1 Key Before:\n436 0x155a1b8 OSK1 32 ch8* 0x90 0x285570 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nOSK1 Key After:\n436 0x155a1b8 OSK1 32 ch8* 0x90 0x2853c0 65 61 73 65 64 6F 6E 74 73 74 65 61 6C 28 63 29 41 70 70 6C 65 43 6F 6D 70 75 74 65 72 49 6E 63 \n\nModifying RELA records from: 0x285570 to 0x2853c0\ne_shoff: 0x1dcd450 e_shentsize: 0x40 e_shnum:0x29 e_shstrndx:0x28\nRelocation modified at: 0xf71a8\nRelocation modified at: 0xf71c0\nRelocation modified at: 0xf9aa0\nRelocation modified at: 0xf9ab8\nFile: /usr/lib/vmware/bin/vmware-vmx-stats\n\nappleSMCTableV0 (smc.version = \"0\")\nappleSMCTableV0 Address      : 0x1208ae0\nappleSMCTableV0 Private Key #: 0xF2/242\nappleSMCTableV0 Public Key  #: 0xF0/240\nappleSMCTableV0 Table        : 0x1208b00\n+LKS Key: \n002 0x1208b48 +LKS 01 flag 0x90 0x259190 07 \nOSK0 Key Before:\n241 0x120ce80 OSK0 32 ch8* 0x80 0x259200 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \nO
- name: Patch VMWare for Mac OS X
  command: bash lnx-install.sh
  args:
    chdir: "{{ unlocker_temp_dir }}"
    creates: /usr/lib/vmware/isoimages/darwin.iso
  when: false

- name: Remove the temporary Unlocker directory
  file:
    path: "{{ unlocker_temp_dir }}"
    state: absent
