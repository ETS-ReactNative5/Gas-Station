---
- name: Check if the license file is available on the controller
  stat:
    path: "{{ vmware_license_local_path }}"
  register: license_local_file
  delegate_to: localhost

- name: Install the Vagrant VMWare desktop plugin and add license
  block:
    - name: Copy the license file to the target
      copy:
        src: "{{ vmware_license_local_path }}"
        dest: "{{ vmware_license_remote_path }}"

    - name: Install the Vagrant VMWare desktop plugin
      command: vagrant plugin install vagrant-vmware-desktop

    - name: Install the licesnse for Vagrant VMWare desktop plugin
      command: "vagrant plugin license vagrant-vmware-desktop {{ vmware_license_remote_path }}"
  always:
    - name: Remove the license file from target
      file:
        path: "{{ vmware_license_remote_path }}"
        state: absent
  when:
    - license_local_file.stat.exists
    - vagrant_vmware_support
