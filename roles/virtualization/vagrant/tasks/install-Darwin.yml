---
- name: Ensure Vagrant is installed
  become: false
  homebrew_cask:
    name: vagrant
    state: present
    sudo_password: "{{ ansible_password }}"

- name: Ensure the Vagrant VMWare Utility is installed
  become: false
  homebrew_cask:
    name: vagrant-vmware-utility
    state: present
    sudo_password: "{{ ansible_password }}"
  when: vagrant_vmware_support

- name: Check if the license file is available on the controller
  stat:
    path: "{{ vmware_license_local_path }}"
  register: license_local_file
  delegate_to: localhost

- name: Install the Vagrant VMWare desktop plugin and add a license
  block:
    - name: Copy the license file to the target
      copy:
        dest: "{{ vmware_license_remote_path }}"
        mode: 0444
        src: "{{ vmware_license_local_path }}"

    - name: Install the Vagrant VMWare desktop plugin
      command: vagrant plugin install vagrant-vmware-desktop

    - name: Install the license for Vagrant VMWare desktop plugin
      command: "vagrant plugin license vagrant-vmware-desktop {{ vmware_license_remote_path }}"
  always:
    - name: Remove the license file from target
      file:
        path: "{{ vmware_license_remote_path }}"
        state: absent
  when:
    - license_local_file.stat.exists
    - vagrant_vmware_support
