---
- name: Install Vagrant via Chocolatey
  chocolatey.chocolatey.win_chocolatey:
    name: vagrant
    state: latest

- name: Check if Vagrant installation is in default location
  win_stat:
    path: "{{ vagrant_default_dir }}"
  register: hashicorp_default_location

- name: Move the Vagrant installation to Program Files
  win_shell: 'Move-Item {{ vagrant_default_dir }} "{{ vagrant_destination_dir }}"'
  when:
    - hashicorp_default_location.stat.exists is defined
    - hashicorp_default_location.stat.exists

- name: Delete original Vagrant directory
  win_file:
    path: "{{ vagrant_default_parent_dir }}"
    state: absent

- name: Remove original Vagrant PATH
  win_path:
    elements: "{{ vagrant_default_dir }}\\bin"
    state: absent

- name: Add new Vagrant PATH
  win_path:
    elements: "{{ vagrant_destination_dir }}\\bin"
    state: present

- name: Install the Vagrant VMWare desktop plugin
  win_chocolatey:
    name: vagrant-vmware-utility
    state: present
  when: vagrant_vmware_support

- name: Check if the license file is available on the controller
  stat:
    path: "{{ vmware_license_local_path }}"
  register: license_local_file
  delegate_to: localhost

- name: Install the Vagrant VMWare desktop plugin and add a license
  block:
    - name: Copy the license file to the target
      win_copy:
        src: "{{ vmware_license_local_path }}"
        dest: "{{ vmware_license_remote_path_win }}"

    - name: Install the license for Vagrant VMWare desktop plugin
      shell: "vagrant plugin license vagrant-vmware-desktop {{ vmware_license_remote_path_win }}"
  always:
    - name: Remove the license file from target
      file:
        path: "{{ vmware_license_remote_path_win }}"
        state: absent
  when:
    - vagrant_license_local_file.stat.exists
    - vagrant_vmware_support
