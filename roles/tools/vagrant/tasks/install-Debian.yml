---
- name: Install Vagrant
  apt:
    deb: "{{ vagrant_deb_url }}"

- name: Install Vagrant VMWare Utility package
  apt:
    deb: "{{ vagrant_vmware_utility_deb_url }}"
  when: vagrant_vmware_support

- name: Check if the license file is available on the controller
  stat:
    path: "{{ license_local_path }}"
  register: license_local_file
  delegate_to: localhost

- name: Install the Vagrant VMWare desktop plugin and add license
  block:
    - name: Copy the license file to the target
      copy:
        src: "{{ license_local_path }}"
        dest: "{{ license_remote_path }}"

    - name: Install the Vagrant VMWare desktop plugin
        shell: vagrant plugin install vagrant-vmware-desktop

    - name: Install the licesnse for Vagrant VMWare desktop plugin
        shell: "vagrant plugin license vagrant-vmware-desktop-license {{ license_remote_path }}"

    - name: Remove the license file from target
      file:
        path: "{{ license_remote_path }}"
        state: absent
  when:
    - license_local_file.stat.exists
    - vagrant_vmware_support
