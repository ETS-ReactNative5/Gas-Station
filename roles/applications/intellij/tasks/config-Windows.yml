---
- name: Ensure plugins are installed
  include_tasks: plugin-Windows.yml
  loop: "{{ user.intellij_plugins }}"
  loop_control:
    loop_var: plugin_url
    label: plugin_url
  when: user.intellij_plugins is defined

- name: Ensure Preferences directory exists
  become_method: runas
  become_user: "{{ user.username }}"
  ansible.windows.win_file:
    path: "{{ item }}"
    state: directory
  loop:
    - '%USERPROFILE%\.java'
    - '%USERPROFILE%\.java\.userPrefs'
    - '%USERPROFILE%\.java\.userPrefs\jetbrains'

- name: Check if prefs.xml file is present
  become_method: runas
  become_user: "{{ user.username }}"
  ansible.windows.win_stat:
    path: '%USERPROFILE%\.java\.userPrefs\jetbrains\prefs.xml'
  register: prefs_file_stat

- name: Ensure prefs.xml is updated
  become_method: runas
  become_user: "{{ user.username }}"
  community.windows.win_lineinfile:
    path: '%USERPROFILE%\.java\.userPrefs\jetbrains\prefs.xml'
    insertafter: "^<map "
    line: '  <entry key="eua_accepted_version" value="1.1"/>'
    backup: true
  when: prefs_file_stat.stat.exists

- name: Ensure prefs.xml is created (if not present)
  become_method: runas
  become_user: "{{ user.username }}"
  ansible.windows.win_copy:
    dest: '%USERPROFILE%\.java\.userPrefs\jetbrains\prefs.xml'
    content: |
      <?xml version="1.0" encoding="UTF-8" standalone="no"?>
      <!DOCTYPE map SYSTEM "http://java.sun.com/dtd/preferences.dtd">
      <map MAP_XML_VERSION="1.0">
        <entry key="eua_accepted_version" value="1.1"/>
      </map>
  when: not prefs_file_stat.stat.exists
