---
- name: Generate private key
  become: yes
  become_user: "{{ ansible_user_id }}"
  openssl_privatekey:
    path: "/home/{{ ansible_user }}/.docker/docker-ca-key.pem"
    cipher: aes256
    size: 4096
    state: present
    passphrase: "{{ lookup('file', '/home/{{ ansible_user_id }}/.docker/.pw') }}"

- name: Generate certificate signing request
  become: yes
  become_user: "{{ ansible_user_id }}"
  openssl_csr:
    path: "/home/{{ ansible_user }}/.docker/ca.pem"
    privatekey_path: "/home/{{ ansible_user_id }}/.docker/docker-ca-key.pem"
    privatekey_passphrase: "{{ lookup('file', '/home/{{ ansible_user_id }}/.docker/.pw') }}"
    common_name: "{{ ansible_fqdn }}"
    country_name: US
    state_or_province_name: NJ
    organization_name: Megabyte LLC
    organization_unit_name: Home Lab
    locality_name: The Hood
    digest: sha256
    state: present

- name: Generate server key
  become: yes
  become_user: "{{ ansible_user_id }}"
  openssl_privatekey:
    path: "/home/{{ ansible_user_id }}/.docker/docker-server-key.pem"
    cipher: aes256
    size: 4096
    state: present
