---
- hosts: pfsense
  tasks:
    - name: Update pfSense configuration
      include_tasks: tasks/pfsense/base.yml
- hosts: windows
  tasks:
    - name: Set hosts file
      include_tasks: tasks/windows/hosts.yml
    - name: Register the product key
      include_tasks: tasks/windows/activation.yml
    - name: Update the operating system
      include_tasks: tasks/windows/update.yml
    - name: Ensure software is installed
      include_tasks: tasks/windows/install.yml
    - name: Clean up shortcuts
      include_tasks: tasks/windows/shortcuts.yml
    - name: Modify Windows settings
      include_tasks: tasks/windows/windows-settings.yml
    - name: Add/update dotfiles
      include_tasks: tasks/windows/dotfiles.yml
    - name: Attempt authentication
      include_tasks: tasks/windows/authenticate.yml
    - name: Perform miscellaneous tasks
      include_tasks: tasks/windows/misc.yml
- hosts: all:!windows
  gather_facts: no
  tasks:
    - name: Ensure proper SSH port is used for connecting
      include_tasks: tasks/misc/connect.yml
      when: ansible_connection != 'local'
    - name: Clean up automation files if running locally
      include_tasks: tasks/ubuntu/cleanup.yml
      when: ansible_connection == 'local'
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  tasks:
    - name: Set up authentication (set up .ssh folder)
      include_tasks: tasks/ubuntu/authenticate.yml
- hosts: ubuntu-desktop
  become: yes
  tasks:
    - name: Configure system
      include_tasks: tasks/ubuntu/system/main.yml
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  become: yes
  tasks:
    - name: Revert Tor apt sources for duration of the script
      include_tasks: tasks/ubuntu/applications/tor-apt-revert.yml
    - name: Configure /etc/hosts and set hostname
      include_tasks: tasks/ubuntu/hosts.yml
    - name: Update security settings
      include_role:
        name: geerlingguy.security
    - name: Update the operating system
      include_tasks: tasks/ubuntu/update.yml
    - name: Ensure Ubuntu software is installed
      include_tasks: tasks/ubuntu/install.yml
    - name: Run miscellaneous root tasks
      include_tasks: tasks/ubuntu/misc.yml
    - name: Set up the /swapfile
      include_tasks: tasks/ubuntu/swap.yml
    - name: Ensure netdata is installed
      include_tasks: tasks/ubuntu/netdata.yml
    - name: Set up integrations
      include_tasks: tasks/ubuntu/integrations/main.yml
- hosts: raspberry:ubuntu-desktop:ubuntu-server
  become: yes
  tasks:
    - name: Apply firewall rules
      include_tasks: tasks/ubuntu/ufw.yml
    - name: Install Samba share
      include_tasks: tasks/ubuntu/samba.yml
      when: samba_users is defined
    - name: Set up CUPS printer sharing
      include_tasks: tasks/ubuntu/applications/cups.yml
      when:
        - printer_sharing is defined
        - printer_sharing
- hosts: raspberry:ubuntu-desktop:ubuntu-server
  tasks:
    - name: Install and configure WireGuard
      include_tasks: tasks/ubuntu/applications/wireguard.yml
      when: wireguard_nmconnections is defined
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  become: yes
  tasks:
    - name: Install NodeJS/NPM
      include_role:
        name: geerlingguy.nodejs
      when: (nodejs_npm_global_packages | default([])) | length
    - name: Install Java
      include_role:
        name: geerlingguy.java
      when: java_home is defined
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  tasks:
    - name: Ensure Homebrew and accompanying packages are installed
      include_tasks: tasks/ubuntu/homebrew.yml
      when: (homebrew_packages | default([])) | length
    - name: Add dotfiles
      include_tasks: tasks/ubuntu/dotfiles.yml
- hosts: ubuntu-desktop
  become: yes
  tasks:
    - name: Add OpenVPN profiles
      include_tasks: tasks/ubuntu/vpn-client.yml
    - name: Install VMWare
      include_tasks: tasks/ubuntu/vmware.yml
    - name: Install Wireshark
      include_tasks: tasks/ubuntu/applications/wireshark.yml
    - name: Install TeamViewer
      include_tasks: tasks/ubuntu/applications/teamviewer.yml
- hosts: ubuntu-desktop
  tasks:
    - name: Run miscellaneous desktop tasks
      include_tasks: tasks/ubuntu/desktop-misc.yml
    - name: Install Hyper.js
      include_tasks: tasks/ubuntu/hyper.yml
    - name: Include AppImages
      include_tasks: tasks/ubuntu/appimages.yml
    - name: Install/Update Postman
      include_tasks: tasks/ubuntu/postman.yml
    - name: Set up HTPC
      include_tasks: tasks/ubuntu/htpc.yml
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  tasks:
    - name: Set up git repositories
      include_tasks: tasks/misc/git.yml
- hosts: all:!windows:!pfsense
  tasks:
    - name: Install AWX
      include_role:
        name: geerlingguy.awx
      when: ('awx' in (apps_installed | default([])))
    - name: Install InstaPy
      include_role:
        name: professormanhattan.ansible_instapy
      when: ('instapy' in (apps_installed | default([])))
    - name: Install MAAS
      include_role:
        name: professormanhattan.ansible_maas
      when: ('maas' in (apps_installed | default([])))
    - name: Install PiHole
      include_role:
        name: professormanhattan.ansible_pihole_cloudflared
      when: ('pihole' in (apps_installed | default([])))
- hosts: all:!windows:!pfsense
  become: yes
  tasks:
    - name: Install NGINX Optimized
      include_role:
        name: professormanhattan.ansible_nginx_optimized
      when: (nginx_sites_available | default([])) | length
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  become: yes
  tasks:
    - name: Install Tor services
      include_tasks: tasks/ubuntu/applications/tor.yml
#- hosts: ubuntu-server
#  become: yes
#  tasks:
#    - name: Enroll system in JumpCloud
#      include_tasks: tasks/misc/jumpcloud.yml
- hosts: raspberry:ubuntu-desktop:ubuntu-server:ubuntu-wsl
  become: yes
  tasks:
    - name: Apply patches
      include_tasks: tasks/ubuntu/patches/main.yml