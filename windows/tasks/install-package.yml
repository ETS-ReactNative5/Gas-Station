---
- name: "Ensure \"{{ item.name }}\" is installed"
  win_chocolatey:
    name: "{{ item.name | default(item) }}"
    params: "{{ item.params | default('') }}"
    state: "{{ item.state | default('present') }}"
    version: "{{ item.version | version('latest') }}"
  register: installation
- debug:
    var: installation
- name: "Check if the {{ software_meta[item.name].folder }} start menu shortcut is in the default location"
  win_stat:
    path: "{{ windows_startmenu }}\\{{ software_meta[item.name].folder }}\\{{ software_meta[item.name].link }}.lnk"
  register: startmenu_shortcut
  when:
    - software_meta[item.name].folder is defined
    - software_meta[item.name].link is defined
- name: "Move the {{ software_meta[item.name].folder }} shortcut to parent directory if it is in the default location"
  win_shell: "mv '{{ windows_startmenu }}\\{{ software_meta[item.name].folder }}\\{{ software_meta[item.name].link }}.lnk' '{{ windows_startmenu }}\\{{ software_meta[item.name].rename | default(software_meta[item.name].link) }}.lnk'"
  when:
   - startmenu_shortcut.stat.exists is defined
   - startmenu_shortcut.stat.exists
- name: "Remove the {{ software_meta[item.name].folder }} folder from the start menu"
  win_file:
    path: "{{ windows_startmenu }}\\{{ software_meta[item.name].folder }}"
    state: absent
  when: software_meta[item.name].folder is defined
- name: Reboot if the installation of {{ item.name }} requires it
  win_reboot:
  when:
    - installation.reboot_required is defined
    - installation.reboot_required