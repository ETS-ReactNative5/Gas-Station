# Copyright 2020, Megabyte LLC <help@megabyte.space>

# This playbook is the main script that makes sure the appropriate software
# is installed for a given environment.

---
- name: Configure Windows optional features
  win_optional_feature:
    name: "{{ item.name | default(item) }}"
    state: "{{ item.state | default('present') }}"
  register: optional_features
  with_items: "{{ windows_features }}"
- set_fact:
    needs_reboot: "True in {{ optional_features | json_query('results[*].reboot_required') }}"
- name: Reboot if the configuration of optional features requires it
  win_reboot:
  when: "{{ needs_reboot | bool }}"
- name: Remove unnecessary APPX packages
  win_shell: |
    Get-AppxPackage -AllUsers -Name {{ item | default(item) }} | Remove-AppxPackage -AllUsers -ErrorAction SilentlyContinue
    Get-AppxProvisionedPackage -Online | where {$_.PackageName -like {{ item | default(item) }}} | Remove-AppxProvisionedPackage -AllUsers -Online -ErrorAction SilentlyContinue
  with_items: "{{ appx_removals }}"
- name: Install software via Chocolatey
  win_chocolatey:
    name: "{{ item.name | default(item) }}"
    params: "{{ item.params | default('') }}"
    state: "{{ item.state | default('present') }}"
  with_items: "{{ choco_apps }}"
- name: Install Visual Studio Code plugins to via Chocolatey
  win_chocolatey:
    name: "{{ item | default(item) }}"
    state: latest
  with_items: "{{ choco_vscode_plugins }}"
- name: Install global NPM packages
  npm:
    name: "{{ item || default(item) }}"
    global: yes
  with_items: "{{ npm_globals }}"