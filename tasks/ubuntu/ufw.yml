---
- name: Reset UFW
  ufw:
    state: reset
- name: Set default incoming policy to deny
  ufw:
    default: deny
    direction: incoming
- name: Enable UFW logging
  ufw:
    logging: 'on'
  ignore_errors: yes
- name: Limit connections via SSH to prevent brute force attacks
  ufw:
    rule: limit
    port: "{{ security_ssh_port }}"
    proto: tcp
    src: "{{ item }}"
    comment: Allow and limit SSH connections
  loop:
    - 192.168.69.0/24
- name: Allow all access to TCP port 443
  ufw:
    rule: allow
    port: '443'
    proto: tcp
    comment: Allow HTTPS
  when: software | default([]) | selectattr("name", "equalto", "nginx") | list | first | default(false)
- name: Allow RDP access if xrdp is installed
  ufw:
    rule: allow
    port: '3389'
    proto: tcp
    src: "{{ item }}"
    comment: Allow RDP
  loop:
    - 192.168.69.14
  when: software | default([]) | selectattr("name", "equalto", "xrdp") | list | first | default(false)
- name: Enable UFW
  ufw:
    state: enabled