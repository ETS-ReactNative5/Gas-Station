---
- name: Ensure Public Media folder exists
  file:
    path: "/home/{{ ansible_user }}/Public/Media"
    state: directory
    owner: nobody
    group: nogroup
    mode: "755"
- name: Ensure Public Public folder exists
  file:
    path: "/home/{{ ansible_user }}/Public/Public"
    state: directory
    owner: nobody
    group: nogroup
    mode: "770"
- name: Add Shared Documents to Public folder
  file:
    src: "/home/{{ ansible_user }}/Documents/Shared"
    dest: "/home/{{ ansible_user }}/Public/Media/Documents"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Add Games to Public folder
  file:
    src: /mnt/auxilary/Games
    dest: "/home/{{ ansible_user }}/Public/Media/Games"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Add Movies to Public folder
  file:
    src: /mnt/movies
    dest: "/home/{{ ansible_user }}/Public/Media/Movies"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Add Music to Public folder
  file:
    src: "/home/{{ ansible_user }}/Music"
    dest: "/home/{{ ansible_user }}/Public/Media/Music"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Add Pictures to Public folder
  file:
    src: "/home/{{ ansible_user }}/Pictures/Shared"
    dest: "/home/{{ ansible_user }}/Public/Media/Pictures"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Add TV to Public folder
  file:
    src: /mnt/tv
    dest: "/home/{{ ansible_user }}/Public/Media/TV"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Add Videos to Public folder
  file:
    src: /mnt/auxilary/Videos
    dest: "/home/{{ ansible_user }}/Public/Media/Videos"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
- name: Install Samba
  apt:
    name: samba
    state: latest
- name: Create the Public Public folder
  file:
    path: "/home/{{ ansible_user }}/Public/Public"
    owner: nobody
    group: "{{ ansible_user }}"
    mode: "775"
    state: directory
- name: Ensure group "sambausers" exists
  group:
    name: sambausers
    state: present
- name: Ensure Protected folder has appropriate permissions
  file:
    path: "/home/{{ ansible_user }}/Documents/Protected"
    state: directory
    owner: root
    group: sambausers
    mode: "770"
- name: Add Samba users that require access to the Protected Samba Share
  user:
    comment: "User that is allowed access to the Protected Samba share"
    create_home: no
    groups: "{{ item.groups | default(['sambauser']) }}"
    name: "{{ item.name }}"
    password: "{{ item.password }}"
  with_items: "{{ samba_users | default([]) }}"
- name: Add Samba password to Samba users
  shell: "printf '{{ item.samba_password }}\n{{ item.samba_password }}\n' | smbpasswd -a {{ item.name }}"
  with_items: "{{ samba_users | default([]) }}"
- name: Configure Samba for sharing the Public folder
  blockinfile:
    path: /etc/samba/smb.conf
    marker: "# ANSIBLE MANAGED BLOCK FOR PUBLIC FOLDER SHARE"
    block: |
      [global]
        hosts allow = 127. 192.168. 10.0.0.
        load printers = yes
        map to guest = bad user
        netbios name = {{ samba_netbios_name }}
        obey pam restrictions = yes
        printing = CUPS
        proxy = no
        security = user
        server role = standalone server
        server string = https://my.home.megabyte.space
        unix extension = no
        workgroup = WORKGROUP
      [Media]
        browsable = yes
        comment = Movies, TV Shows, and a bunch of other stuff (read-only)
        follow symlinks = yes
        force user = nobody
        guest only = yes
        guest ok = yes
        path = /home/{{ ansible_user }}/Public/Media
        read only = yes
        wide links = yes
      [Public]
        browsable = yes
        comment = Public network share
        directory mode = 0777
        follow symlinks = no
        force create mode = 0777
        force directory mode = 0777
        force user = nobody
        guest ok = yes
        guest only = yes
        path = /home/{{ ansible_user }}/Public/Public
        read only = no
        writable = yes
      [printers]
        browsable = yes
        comment = Printers
        create mode = 0700
        guest ok = yes
        path = /var/spool/samba
        printable = yes
        printer admin = root
        read only = yes
        writable = no
      [print$]
        browsable = yes
        comment = Printer drivers
        guest ok = yes
        path = /var/lib/samba/printers
        read only = yes
      [HP_OfficeJet_Pro_6978]
        comment = HP OfficeJet Pro 6978 (in Garage)
        guest ok = yes
        path = /var/spool/samba
        printable = yes
        printer admin = root
        public = yes
      [Private]
        browsable = yes
        comment = Authenticated share with read/write capabilities
        directory mode = 0777
        follow symlinks = no
        force create mode = 0777
        guest only = no
        guest ok = no
        path = /home/{{ ansible_user }}/Documents/Protected
        read only = no
        valid users = @sambauser
        writable = yes
# Source: https://www.linuxbabe.com/ubuntu/set-up-cups-print-server-ubuntu-bonjour-ipp-samba-airprint
- name: Download CUPS and related packages
  apt:
    name:
      - avahi-daemon 
      - cups
    state: latest
- name: Copy the CUPS configuration over
  copy:
    src: files/config/cupsd.conf
    dest: /etc/cups/cupsd.conf
    owner: root
    group: root
    mode: "644"
- name: Restart CUPS and enable on start up
  systemd:
    name: cups
    state: restarted
    enabled: yes
- name: Restart avahi-daemon and enable on start up
  systemd:
    name: avahi-daemon
    state: restarted
    enabled: yes
- name: Restart the Samba service
  service:
    name: smbd
    state: restarted
- name: Configure UFW for Samba
  ufw:
    rule: allow
    name: samba
    src: "{{ item }}"
    comment: Allow LAN access to Samba
  loop: "{{ rc1918_networks }}"
- name: Allow Avahi daemon access
  ufw:
    comment: Allow Bonjour and IPP protocols
    port: "5353"
    proto: udp
    rule: allow
    src: "{{ item }}"
  with_items: "{{ rc1918_networks }}"