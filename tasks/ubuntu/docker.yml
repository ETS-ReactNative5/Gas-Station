---
- name: Create Docker system group
  group:
    name: docker
    state: present
    system: yes
- name: Add user to the Docker system group
  user:
    name: "{{ ansible_user }}"
    groups:
      - docker
    append: yes
- name: Restart the Docker service
  systemd:
    name: "snap.docker.dockerd"
    state: restarted
- name: Allow TCP connections to Docker
  become: yes
  lineinfile:
    path: /etc/systemd/system/snap.docker.dockerd.service
    regex: "ExecStart="
    line: ExecStart=/usr/bin/snap run docker.dockerd -H tcp://0.0.0.0:2424
  when: not ('portainer' in (apps_installed | default([])))