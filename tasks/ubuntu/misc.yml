---
- name: Set MOTD
  copy:
    src: files/config/motd
    dest: /etc/motd
    owner: root
    group: root
    mode: "644"
- name: Set time zone
  timezone:
    name: "{{ system_timezone }}"
- name: Check if Chromium is installed
  stat:
    path: /snap/bin/chromium
  register: chromium_stat
- name: Set Chromium as the default browser if it is installed
  alternatives:
    name: x-www-browser
    link: /usr/bin/x-www-browser
    path: /snap/bin/chromium
    priority: 200
  when: chromium_stat.stat.exists
- name: Make xrdp load on startup if it is installed
  systemd:
    enabled: yes
    name: xrdp
    state: restarted
  when: software | default([]) | selectattr("name", "equalto", "xrdp") | list | first | default(false)
- name: Increase vm_max_map_count if required (Kibana)
  sysctl:
    name: vm.max_map_count
    sysctl_set: yes
    value: '262144'
  when: ('kibana' in (apps_installed | default([])))
- name: Copy UniFi .pem if an NGINX proxy configuration is present
  copy:
    src: files/keys/unifihome.pem
    dest: /etc/ssl/private/unifihome.pem
    owner: root
    group: root
    mode: "640"
  when: nginx_sites_available_proxy | default([]) | selectattr("name", "equalto", "unifihome") | list | first | default(false)
- name: Set ANSIBLE_PLAYBOOK_USER name environment variable
  become: yes
  lineinfile:
    path: /etc/environment
    regex: "^ANSIBLE_PLAYBOOK_USER="
    line: "ANSIBLE_PLAYBOOK_USER={{ ansible_user }}"
- name: Ensure root .ssh folder exists
  become: yes
  file:
    path: /root/.ssh
    state: directory