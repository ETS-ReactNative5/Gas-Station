---
- name: Allow DNS traffic (TCP port 53)
  ufw:
    rule: allow
    port: '53'
    proto: tcp
    src: "{{ item }}"
    comment: Allow local DNS lookups (TCP)
  loop:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
- name: Allow DNS traffic (UDP port 53)
  ufw:
    rule: allow
    port: '53'
    proto: udp
    src: "{{ item }}"
    comment: Allow local DNS lookups (UDP)
  loop:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
- name: Create PiHole directory
  file:
    path: /etc/pihole
    state: directory
- name: Copy PiHole configuration
  copy:
    src: files/ubuntu/pihole-setupVars.conf
    dest: /etc/pihole/setupVars.conf
  register: pihole_config
- name: Register pihole_binary if pihole is present
  stat:
    path: /usr/local/bin/pihole
  register: pihole_binary
- name: Set pihole_installed fact
  set_fact:
    pihole_installed: "{{ pihole_binary.stat.exists | default(false) }}"
- name: Download installation script
  get_url:
    url: https://raw.githubusercontent.com/pi-hole/pi-hole/master/automated%20install/basic-install.sh
    dest: ~/pihole-install.sh
    mode: u+rwx
  when: not pihole_installed
- name: Run the installation script
  shell: ~/pihole-install.sh --unattended
  when: not pihole_installed
- name: Copy dnsmasq configuration
  copy:
    src: files/ubuntu/pihole-dnsmasq-cloudflared.conf
    dest: /etc/dnsmasq.d/50-cloudflared.conf
  register: dnsmasq_config
- name: Check if dnsmasq should be restarted
  set_fact:
    restart_dnsmasq: "{{ true if (pihole_config is changed or dnsmasq_config is changed) else false }}"
- name: Restart dnsmasq if required
  service:
    name: dnsmasq
    enabled: true
    state: restarted
  when: restart_dnsmasq
