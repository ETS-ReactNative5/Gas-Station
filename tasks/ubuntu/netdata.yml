---
- name: Check if netdata is already installed
  stat:
    path: /etc/netdata
  register: netdata_stat
- name: Download the netdata kickstart.sh file
  get_url:
    url: https://my-netdata.io/kickstart.sh
    dest: /tmp/kickstart.sh
  when: not netdata_stat.stat.exists
- name: Install netdata if it is not already installed
  shell: bash /tmp/kickstart.sh --dont-wait --stable-channel --disable-telemetry
  when: not netdata_stat.stat.exists
  register: netdata_install_stat
- name: Add optimization for kernel memory de-duper (/sys/kernel/mm/ksm/run)
  shell: echo 1 >/sys/kernel/mm/ksm/run
  when:
    - not netdata_stat.stat.exists
    - '"You have a kernel memeory de-duper" in netdata_install_stat.stdout'
- name: Add optimization for kernel memory de-duper (/sys/kernel/mm/ksm/sleep_millisecs)
  shell: echo 1000 >/sys/kernel/mm/ksm/sleep_millisecs
  when:
    - not netdata_stat.stat.exists
    - '"You have a kernel memeory de-duper" in netdata_install_stat.stdout'
- debug:
    msg: "{{ netdata_install_stat.stdout }}"
  when: not netdata_stat.stat.exists
- name: Restart netdata
  service:
    name: netdata
    state: restarted
- name: Wait for netdata to stabilize
  wait_for:
    timeout: 3
- name: Add instance to netdata cloud
  shell: "netdata-claim.sh -token={{ vault_netdata_token }} -rooms={{ netdata_room }} -url=https://app.netdata.cloud"
  when: not netdata_stat.stat.exists
- name: Ensure kickstart.sh is removed
  file:
    path: /tmp/kickstart.sh
    state: absent
    
