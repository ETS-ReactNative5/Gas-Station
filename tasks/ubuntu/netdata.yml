---
- name: Check if netdata is already installed
  stat:
    path: /usr/sbin/netdata
  register: netdata_stat
- name: Install netdata if it is not already installed
  expect:
    command: bash <(curl -Ss https://my-netdata.io/kickstart.sh) --dont-wait --stable-channel --disable-telemetry
    responses:
      You have a kernel memory de-duper: echo 1 >/sys/kernel/mm/ksm/run && echo 1000 >/sys/kernel/mm/ksm/sleep_millisecs
  when: not netdata_stat.stat.exists
- name: Add instance to netdata cloud
  shell: "netdata-claim.sh -token={{ vault_netdata_token }} -rooms={{ netdata_room }} -url=https://app.netdata.cloud"