---
- name: Ensure openssh-server is installed
  become: yes
  apt:
    name: openssh-server
    state: latest
- name: Ensure .ssh directory exists.
  file: 
    dest: ~/.ssh
    mode: "700"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
- name: Ensure .ssh directory exists for root user
  become: yes
  file:
    dest: ~/.ssh
    mode: "700"
    owner: root
    group: root
    state: directory
  when: ssh_private_keys_root is defined
- name: Set authorized key
  authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ lookup('file', 'files/keys/{{ authorized_key_file }}') }}"
  when: authorized_key_file is defined
- name: Copy SSH private keys
  copy:
    src: "files/keys/{{ item }}"
    dest: "~/.ssh/{{ item }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "600"
  with_items: "{{ ssh_private_keys | default([]) }}"
- name: Copy SSH private keys for root user
  become: yes
  copy:
    src: "files/keys/{{ item }}"
    dest: "~/.ssh/{{ item }}"
    owner: root
    group: root
    mode: "600"
  with_items: "{{ ssh_private_keys_root | default([]) }}"
- name: Copy SSH public keys
  copy:
    src: "files/keys/{{ item }}.pub"
    dest: "~/.ssh/{{ item }}.pub"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "644"
  with_items: "{{ ssh_private_keys | default([]) }}"
- name: Copy SSH public keys for root user
  become: yes
  copy:
    src: "files/keys/{{ item }}.pub"
    dest: "~/.ssh/{{ item }}.pub"
    owner: root
    group: root
    mode: "644"
  with_items: "{{ ssh_private_keys_root | default([]) }}"
- name: Copy SSH known_hosts
  copy:
    src: files/keys/known_hosts
    dest: ~/.ssh/known_hosts
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "644"
  when: ssh_private_keys is defined
- name: Copy SSH known_hosts for root
  become: yes
  copy:
    src: files/keys/known_hosts
    dest: ~/.ssh/known_hosts
    owner: root
    group: root
    mode: "644"
  when: ssh_private_keys_root is defined
- name: Copy SSH config
  copy:
    src: files/keys/config
    dest: ~/.ssh/config
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "644"
  when: ssh_private_keys is defined
- name: Copy SSH config for root
  become: yes
  copy:
    src: files/keys/config
    dest: ~/.ssh/config
    owner: root
    group: root
    mode: "644"
  when: ssh_private_keys_root is defined
- name: Ensure Playbooks git repository is updated
  become: yes
  become_user: "{{ ansible_user }}"
  command: "git remote set-url origin {{ playbooks_source_repository }}"
  args:
    chdir: "/home/{{ ansible_user }}/Playbooks"
  when: ansible_connection == 'local'
