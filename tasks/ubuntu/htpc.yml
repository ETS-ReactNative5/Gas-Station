---
- name: Integrate HTPC folders with user directory
  include_tasks: tasks/ubuntu/htpc-folder.yml
  with_items: "{{ htpc_folders | default([]) }}"
- name: Check if ~/HTPC is already initialized with a .git folder
  stat:
    path: ~/HTPC/.git
  register: htpc_git_folder
  when: htpc_repository is defined
- name: Clone HTPC data from GitLab
  git:
    repo: "{{ htpc_repository }}"
    dest: ~/HTPC
  when:
    - htpc_repository is defined
    - not htpc_git_folder.stat.exists
- name: Start the HTPC suite of software
  command: "{{ docker_compose_binary }} up -d"
  args:
    chdir: ~/HTPC
  when: htpc_repository is defined
- name: Add Cron job to HTPC repository in sync
  become: yes
  cron:
    name: HTPC GitLab Sync
    minute: "30"
    user: "{{ ansible_user }}"
    job: "cd ~/HTPC && git add --all && git commit -m 'Ansible auto-sync' && git push origin master"
    cron_file: htpc_gitlab_sync
  when: htpc_repository is defined