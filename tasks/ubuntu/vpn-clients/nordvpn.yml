---
- name: Acquire the current VPN connections
  command: nmcli connection show
  changed_when: false
  register: nmcli_connections
- name: Import NordVPN OpenVPN file into the Network Manager
  shell: "nmcli connection import type openvpn file /home/{{ ansible_user }}/.config/openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_nordvpn_email }}"
  when: item.name not in (nmcli_connections.stdout | join(''))
- name: Change password flag
  lineinfile:
    path: "/etc/NetworkManager/system-connections/{{ item.name }}.nmconnection"
    regex: "password-flags=1"
    line: password-flags=0
#- name: Set DNS server
#  lineinfile:
#    path: "/etc/NetworkManager/system-connections/{{ item.name }}.nmconnection"
#    regex: "password-flags"
- name: Wait for NetworkManager to be ready
  wait_for:
    timeout: 5
  delegate_to: localhost
- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted
- name: Set password for NordVPN OpenVPN connection
  become: yes
  shell: "nmcli connection modify '{{ item.name }}' vpn.secrets 'password={{ vault_nordvpn_password }}'"