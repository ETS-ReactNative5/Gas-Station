---
- name: Set hostname
  hostname:
    name: "{{ hostname }}"
  when: hostname is defined
- name: Set up /etc/hosts file
  lineinfile:
    dest: /etc/hosts
    regexp: "{{ hosts[item].regexp }}"
    line: "{{ hosts[item].ip_address }} {{ hosts[item].hosts }} {{ hosts[item].regexp }}"
    state: present
  when:
    - item not in (apps_installed | default([]))
    - not (hosts_override | default(false))
    - not (no_hosts | default(false))
  with_items: "{{ hosts | list }}"
- name: Set up /etc/hosts for client with hosts_override set
  lineinfile:
    dest: /etc/hosts
    regexp: "{{ hosts[item].regexp }}"
    line: "{{ hosts[item].ip_address }} {{ hosts[item].hosts }} {{ hosts[item].regexp }}"
    state: present
  when: item in (hosts_override | default([]))
  with_items: "{{ hosts | list }}"
- name: Set up /etc/hosts file for local services
  lineinfile:
    dest: /etc/hosts
    regexp: "{{ hosts[item].regexp }}"
    line: "127.0.0.1 {{ hosts[item].hosts }} {{ hosts[item].regexp }}"
    state: present
  when: item in (apps_installed | default([]))
  with_items: "{{ hosts | list }}"