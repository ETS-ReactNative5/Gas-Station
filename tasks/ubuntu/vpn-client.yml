---
- name: Copy OpenVPN files
  copy:
    src: "files/openvpn/"
    dest: "~/openvpn_tmp"
- stat:
    path: ~/.openvpn_setup
  register: openvpn_setup
- set_fact:
    openvpn_configured: "{{ openvpn_setup.stat.exists | default(false) }}"
- name: Import OpenVPN files into the Network Manager
  when: not openvpn_configured
  shell: |
    cd ~/openvpn_tmp/mullvad-hong-kong
    nmcli connection import type openvpn file "Mullvad Hong Kong.conf"
    nmcli connection modify "Mullvad Hong Kong" +vpn.data username={{ vault_mullvad_id }}
    nmcli con modify "Mullvad Hong Kong" vpn.secrets "password={{ vault_mullvad_password }}"
    cd ../mullvad-italy
    nmcli connection import type openvpn file "Mullvad Italy.conf"
    nmcli connection modify "Mullvad Italy" +vpn.data username={{ vault_mullvad_id }}
    nmcli con modify "Mullvad Italy" vpn.secrets "password={{ vault_mullvad_password }}"
    cd ../mullvad-la
    nmcli connection import type openvpn file "Mullvad LA (UDP 53).conf"
    nmcli connection modify "Mullvad LA (UDP 53) +vpn.data username={{ vault_mullvad_id }}
    nmcli con modify "Mullvad LA (UDP 53)" vpn.secrets "password={{ vault_mullvad_password }}"
    cd ../mullvad-nyc
    nmcli connection import type openvpn file "Mullvad NYC.conf"
    nmcli connection modify "Mullvad NYC" +vpn.data username={{ vault_mullvad_id }}
    nmcli con modify "Mullvad NYC" vpn.secrets "password={{ vault_mullvad_password }}"
    cd ../mullvad-secaucus
    nmcli connection import type openvpn file "Mullvad Secaucus.conf"
    nmcli connection modify "Mullvad Secaucus" +vpn.data username={{ vault_mullvad_id }}
    nmcli con modify "Mullvad Secaucus" vpn.secrets "password={{ vault_mullvad_password }}"
    cd ../nordvpn-usa
    nmcli connection import type openvpn file "NordVPN USA.ovpn"
    nmcli connection modify "NordVPN USA" +vpn.data username={{ vault_nordvpn_email }}
    nmcli con modify "NordVPN USA" vpn.secrets "password={{ vault_nordvpn_password }}"
    cd ../nordvpn-usa-2
    nmcli connection import type openvpn file "NordVPN USA2.ovpn"
    nmcli connection modify "NordVPN USA2" +vpn.data username={{ vault_nordvpn_email }}
    nmcli con modify "NordVPN USA2" vpn.secrets "password={{ vault_nordvpn_password }}"
- name: Remove imported certificates from user directory
  file:
    path: ~/openvpn_tmp
    state: absent

