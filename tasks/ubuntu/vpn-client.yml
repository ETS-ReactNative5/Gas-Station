---
- name: Copy OpenVPN files
  copy:
    src: "files/openvpn/"
    dest: "~/openvpn_tmp"
- stat:
    path: ~/.openvpn_setup
  register: openvpn_setup
- set_fact:
    openvpn_configured: "{{ openvpn_setup.stat.exists | default(false) }}"
- name: Import Mullvad OpenVPN files into the Network Manager
  when: not openvpn_configured
  shell: "nmcli connection import type openvpn file ~/openvpn_tmp/{{ item.folder }}/'{{ item }}.conf' && nmcli connection modify '{{ item }}' +vpn.data username={{ vault_mullvad_id }} && nmcli con modify '{{ item }}' vpn.secrets 'password={{ vault_mullvad_password }}'"
  with_items:
    - folder: mullvad-hong-kong
      name: Mullvad Hong Kong
    - folder: mullvad-italy
      name: Mullvad Italy
    - folder: mullvad-la
      name: Mullvad LA (UDP 53)
    - folder: mullvad-nyc
      name: Mullvad NYC
    - folder: mullvad-secaucus
      name: Mullvad Secaucus
    nmcli connection import type openvpn file 'Mullvad Secaucus.conf'
    nmcli connection modify 'Mullvad Secaucus' +vpn.data username={{ vault_mullvad_id }}
    nmcli con modify 'Mullvad Secaucus' vpn.secrets 'password={{ vault_mullvad_password }}'
    cd ../nordvpn-usa
    nmcli connection import type openvpn file 'NordVPN USA.ovpn'
    nmcli connection modify 'NordVPN USA' +vpn.data username={{ vault_nordvpn_email }}
    nmcli con modify 'NordVPN USA' vpn.secrets 'password={{ vault_nordvpn_password }}'
    cd ../nordvpn-usa-2
    nmcli connection import type openvpn file 'NordVPN USA2.ovpn'
    nmcli connection modify 'NordVPN USA2' +vpn.data username={{ vault_nordvpn_email }}
    nmcli con modify 'NordVPN USA2' vpn.secrets 'password={{ vault_nordvpn_password }}'
- name: Remove imported certificates from user directory
  file:
    path: ~/openvpn_tmp
    state: absent

