---
- name: Remove previous OpenVPN files
  become: yes
  become_user: "{{ vault_linux_username }}"
  file:
    path: ~/.config/openvpn
    state: absent
- name: Remove NetworkManager configs
  file:
    path: /etc/NetworkManager/system-connections/
    state: absent
- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted
- name: Copy OpenVPN files
  become: yes
  become_user: "{{ vault_linux_username }}"
  copy:
    src: "files/openvpn/"
    dest: "~/.config/openvpn"
- name: Import Mullvad OpenVPN files into the Network Manager
  shell: "nmcli connection import type openvpn file /home/{{ vault_linux_username }}/.config/openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_mullvad_id }}"
  with_items: "{{ mullvad_connections | default([]) }}"
- name: Modify Mullvad password files with proper permissions
  file:
    path: "/home/{{ vault_linux_username }}/.config/openvpn/{{ item.folder }}/mullvad_userpass.txt"
    mode: '0600'
  with_items: "{{ mullvad_connections | default([]) }}"
#- name: Set password for Mullvad OpenVPN connections
#  become: yes
#  become_user: "{{ vault_linux_username }}"
#  shell: "sudo nmcli connection modify '{{ item.name }}' vpn.secrets 'password={{ vault_mullvad_password }}'"
#  with_items: "{{ mullvad_connections | default([]) }}"
- name: Import NordVPN OpenVPN files into the Network Manager
  shell: "nmcli connection import type openvpn file /home/{{ vault_linux_username }}/.config/openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_nordvpn_email }}"
  with_items: "{{ nordvpn_connections | default([]) }}"