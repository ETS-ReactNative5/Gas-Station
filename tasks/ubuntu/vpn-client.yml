---
- name: Remove previous OpenVPN files
  become: yes
  become_user: "{{ vault_linux_username }}"
  file:
    path: ~/.openvpn
    state: absent
- name: Remove NetworkManager configs
  file:
    path: /etc/NetworkManager/system-connections/
    state: absent
- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted
- name: Copy OpenVPN files
  become: yes
  become_user: "{{ vault_linux_username }}"
  copy:
    src: "files/openvpn/"
    dest: "~/.openvpn"
- name: Import Mullvad OpenVPN files into the Network Manager
  become: yes
  become_user: "{{ vault_linux_username }}"
  shell: "sudo nmcli connection import type openvpn file ~/.openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && sudo nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_mullvad_id }} && sudo nmcli con modify '{{ item.name }}' vpn.secrets 'password={{ vault_mullvad_password }}'"
  with_items:
    - folder: mullvad-denver
      name: Mullvad Denver (UDP 53)
    - folder: mullvad-hong-kong
      name: Mullvad Hong Kong
    - folder: mullvad-italy
      name: Mullvad Italy
    - folder: mullvad-nyc
      name: Mullvad NYC
    - folder: mullvad-secaucus
      name: Mullvad Secaucus (TCP 80)
    - folder: mullvad-zurich
      name: Mullvad Zurich (UDP 53)
- name: Import NordVPN OpenVPN files into the Network Manager
  become: yes
  become_user: "{{ vault_linux_username }}"
  shell: "sudo nmcli connection import type openvpn file ~/.openvpn/{{ item.folder }}/'{{ item.name }}.ovpn' && sudo nmcli connection modify '{{ item.name }}' +vpn.data username={{ vault_nordvpn_email }} && sudo nmcli con modify '{{ item.name }}' vpn.secrets 'password={{ vault_nordvpn_password }}'"
  with_items:
    - folder: nordvpn-usa
      name: NordVPN USA
    - folder: nordvpn-usa-2
      name: NordVPN USA2