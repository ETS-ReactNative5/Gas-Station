---
- name: Remove previous OpenVPN files
  become: yes
  become_user: "{{ ansible_user }}"
  file:
    path: ~/.config/openvpn
    state: absent
- name: Remove NetworkManager configs
  file:
    path: /etc/NetworkManager/system-connections/
    state: absent
  when: refresh_vpn_connections | bool
- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted
- name: Copy OpenVPN files
  become: yes
  become_user: "{{ ansible_user }}"
  copy:
    src: "files/openvpn/"
    dest: "~/.config/openvpn"
- name: Add Mullvad VPN connections
  include_tasks: tasks/ubuntu/vpn-clients/mullvad.yml
  with_items: "{{ mullvad_connections | default([]) }}"
- name: Add NordVPN connections
  include_tasks: tasks/ubuntu/vpn-clients/nordvpn.yml
  with_items: "{{ nordvpn_connections | default([]) }}"
- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted
- name: Add static routes that bypass the VPN
  become: yes
  shell: "ip route add {{ item.prefix }} via {{ item.next_hop }}"
  with_items: "{{ vpn_routes | default([]) }}"
  ignore_errors: yes