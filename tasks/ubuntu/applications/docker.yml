---
- name: Create Docker system group
  group:
    name: docker
    state: present
    system: yes
- name: Add user to the Docker system group
  user:
    name: "{{ ansible_user }}"
    groups:
      - docker
    append: yes
- name: Allow TCP connections to Docker
  become: yes
  lineinfile:
    path: /etc/systemd/system/snap.docker.dockerd.service
    regex: "ExecStart="
    line: ExecStart=/usr/bin/snap run docker.dockerd -H tcp://0.0.0.0:2424 -H unix:///var/run/docker.sock
  when: not ('portainer' in (apps_installed | default([])))
- name: Restart the Docker service
  systemd:
    daemon_reload: yes
    name: "snap.docker.dockerd"
    state: restarted
- name: Check if Docker triggered a restart
  stat:
    path: "/home/{{ ansible_user }}/.config/.docker_rebooted"
  register: docker_restarted
- name: Create file for tracking if Docker triggered a restart
  file:
    path: "/home/{{ ansible_user }}/.config/.docker_rebooted"
    state: touch
  when: not docker_restarted.stat.exists
- name: Reboot the system, if required
  reboot:
    reboot_timeout: 600
  when: not docker_restarted.stat.exists