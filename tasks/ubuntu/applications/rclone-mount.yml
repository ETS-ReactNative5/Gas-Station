---
- name: Ensure user folder is present in /mnt
  file:
    path: "/mnt/{{ ansible_user }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
    mode: "700"
- name: Ensure provider has folder created
  become: yes
  file:
    path: "/mnt/{{ ansible_user }}/{{ item.provider }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
    mode: "700"
- name: Ensure ~/Cloud folder exists
  file:
    path: "/home/{{ ansible_user }}/Cloud"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
    mode: "700"
- name: Create symlink in ~/Cloud
  become: yes
  become_user: "{{ ansible_user }}"
  file:
    src: "/mnt/{{ ansible_user }}/{{ item.provider }}"
    dest: "/home/{{ ansible_user }}/Cloud/{{ item.name }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
    force: yes
- name: Install Rclone mount service
  become: yes
  template:
    src: rclone.service.j2
    dest: "/etc/systemd/system/{{ item.provider }}-rclone.service"
    owner: root
    group: root
    mode: "644"
- name: Start the providers Rclone service
  become: yes
  systemd:
    name: "{{ item.provider }}-rclone.service"
    state: started
    enabled: yes