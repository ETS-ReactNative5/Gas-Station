---
- name: Install AptCacherNG
  apt:
    name: apt-cacher-ng
    state: latest
  when: ('apt' in apps_installed | default([]))
- name: Clear cached apt packages
  shell: rm -rf /var/cache/apt/* && rm -rf /var/lib/apt/lists/*
  when: ('apt' in apps_installed | default([]))
- name: Update apt-get to recognize cleared cache
  apt:
    update_cache: yes
  when: ('apt' in apps_installed | default([]))
- name: Set the appropriate apt proxy URL for integration with AptCacherNG
  copy:
    dest: /etc/apt/apt.conf.d/00apt-cacher-ng
    content: |
      Acquire::http { Proxy "https://{{ apt_cacher_endpoint }}:443"; };
- name: Configure PassThroughPattern
  lineinfile:
    dest: /etc/apt-cacher-ng/acng.conf
    regexp: "#PassThroughPattern: .* # this would allow"
    line: "PassThroughPattern: .*"
  when: ('apt' in apps_installed | default([]))
- name: Configure ExThreshold
  lineinfile:
    dest: /etc/apt-cacher-ng/acng.conf
    regexp: "ExThreshold: "
    line: "ExThreshold: 14"
  when: ('apt' in apps_installed | default([]))
- name: Make AptCacherNG use Tor proxy
  lineinfile:
    dest: /etc/apt-cacher-ng/acng.conf
    regexp: "# AptCacherNG Tor proxy"
    line: "Proxy: http://127.0.0.1:8118 # AptCacherNG Tor proxy"
  when: ('apt' in apps_installed | default([]))
- name: Configure admin account
  lineinfile:
    dest: /etc/apt-cacher-ng/security.conf
    regexp: "#AdminAuth"
    line: "AdminAuth: {{ apt_cacher_username }}:{{ apt_cacher_password }}"
  when: ('apt' in apps_installed | default([]))
- name: Configure /etc/hosts.allow # UFW
  lineinfile:
    dest: /etc/hosts.allow
    regexp: "# AptCacherNG"
    line: "apt-cacher-ng : {{ apt_cacher_allowed_hosts }} # AptCacherNG"
  when: ('apt' in apps_installed | default([]))
- name: Configure /etc/hosts.deny
  lineinfile:
    dest: /etc/hosts.deny
    regexp: "# AptCacherNG"
    line: "apt-cacher-ng : {{ apt_cacher_denied_hosts }} # AptCacherNG"
  when: ('apt' in apps_installed | default([]))
- name: Acquire a list of sources from /etc/apt/sources.list.d/*
  find:
    paths:
      - /etc/apt/sources.list.d
  register: sources_files
  when: ('apt' in apps_installed | default([]))
- name: Configure /etc/apt/sources.list.d/* to use AptCacherNG
  replace:
    path: "{{ item.path }}"
    regexp: " https:\/\/"
    replace: " http://HTTPS///"
  with_items: "{{ sources_files.files }}"
- name: Configure /etc/apt/sources.list to use AptCacherNG
  replace:
    path: /etc/apt/sources.list
    regexp: " https:\/\/"
    replace: " http://HTTPS///"