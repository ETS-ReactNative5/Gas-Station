---
- name: Install Rclone
  apt:
    name: rclone
    state: latest
- name: Ensure ~/.config/rclone
  become: yes
  become_user: "{{ ansible_user }}"
  file:
    path: "/home/{{ ansible_user }}/.config/rclone"
    state: directory
- name: Ensure ~/.config/rclone/rclone.conf exists
  become: yes
  become_user: "{{ ansible_user }}"
  template:
    src: rclone.conf.j2
    dest: /home/{{ ansible_user }}/.config/rclone/rclone.conf
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "600"
- name: Add Rclone mounts
  include_tasks: tasks/ubuntu/applications/rclone-mount.yml
  with_items: "{{ rclone_mounts | default([]) }}"
- name: Ensure ~/Documents is not present on system
  file:
    path: "/home/{{ ansible_user }}/Documents"
    state: absent
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Symlink ~/Documents to OneDrive
  file:
    src: "/mnt/{{ ansible_user }}/onedrive/Documents"
    dest: "/home/{{ ansible_user }}/Documents"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
    force: yes
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Ensure ~/Pictures is not present on system
  file:
    path: "/home/{{ ansible_user }}/Pictures"
    state: absent
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Symlink ~/Pictures to OneDrive
  file:
    src: "/mnt/{{ ansible_user }}/onedrive/Pictures"
    dest: "/home/{{ ansible_user }}/Pictures"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
    force: yes
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Ensure ~/Templates is not present on system
  file:
    path: "/home/{{ ansible_user }}/Templates"
    state: absent
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Symlink ~/Templates to OneDrive
  file:
    src: "/mnt/{{ ansible_user }}/onedrive/Templates"
    dest: "/home/{{ ansible_user }}/Templates"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
    force: yes
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Ensure ~/Music is not present on system
  file:
    path: "/home/{{ ansible_user }}/Music"
    state: absent
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
- name: Symlink ~/Music to OneDrive
  file:
    src: "/mnt/{{ ansible_user }}/onedrive/Music"
    dest: "/home/{{ ansible_user }}/Music"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link
    force: yes
  when: rclone_mounts | default([]) | selectattr("name", "equalto", "OneDrive") | list | first | default(false)
