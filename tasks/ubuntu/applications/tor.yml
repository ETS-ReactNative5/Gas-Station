---
- name: Install Tor and the Tor launcher
  apt:
    name:
      - apt-transport-tor
      - privoxy
      - tor
    state: latest
- name: Forward proxy connections to Tor
  lineinfile:
    path: /etc/privoxy/config
    regex: "forward-socks5 / localhost"
    line: forward-socks5 / localhost:9150 .
- name: Restart Privoxy
  service:
    name: privoxy
    state: restarted
- name: Enforce using USA exit node with Tor connections
  blockinfile:
    path: /etc/tor/torrc
    block: |
      ExitNodes us
      StrictNodes 1
- name: Use port 9150 for torsocks
  lineinfile:
    path: /etc/tor/torsocks.conf
    regex: "TorPort"
    line: TorPort 9150
- name: Set apt to use Tor
  copy:
    src: files/config/tor/apt-tor.conf
    dest: /etc/apt/apt.conf.d/apt-tor.conf
    owner: root
    group: root
    mode: "644"
- name: Reload Tor
  service:
    name: tor
    state: restarted
- name: Acquire a list of sources from /etc/apt/sources.list.d/*
  find:
    paths:
      - /etc/apt/sources.list.d
  register: sources_files
- name: Configure /etc/apt/sources.list.d/* to use Tor as the transport (https://)
  replace:
    path: "{{ item.path }}"
    regexp: " https:\/\/"
    replace: " tor+https://"
  with_items: "{{ sources_files.files }}"
- name: Configure /etc/apt/sources.list.d/* to use Tor as the transport (http://)
  replace:
    path: "{{ item.path }}"
    regexp: " http:\/\/"
    replace: " tor+http://"
  with_items: "{{ sources_files.files }}"
- name: Configure /etc/apt/sources.list to use Tor as the transport (https://)
  replace:
    path: /etc/apt/sources.list
    regexp: " https:\/\/"
    replace: " tor+https://"
- name: Configure /etc/apt/sources.list to use Tor as the transport (http://)
  replace:
    path: /etc/apt/sources.list
    regexp: " http:\/\/"
    replace: " tor+http://"
# Source: https://www.linuxuprising.com/2018/10/how-to-install-and-use-tor-as-proxy-in.html