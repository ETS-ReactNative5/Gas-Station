---
- name: Install Tor and the Tor launcher
  apt:
    name:
      - apt-transport-tor
      - privoxy
      - tor
    state: latest
- name: Forward proxy connections to Tor
  lineinfile:
    path: /etc/privoxy/config
    regex: "forward-socks5 / localhost:9050 ."
    line: forward-socks5 / localhost:9050 .
- name: Restart Privoxy
  service:
    name: privoxy
    state: restarted
- name: Enforce using USA exit node with Tor connections
  blockinfile:
    path: /etc/tor/torrc
    block: |
      ExitNodes us
      StrictNodes 1
- name: Reload Tor
  service:
    name: tor
    state: reloaded
- name: Configure /etc/apt/sources.list/* to use Tor as the transport (https://)
  replace:
    path: "{{ item }}"
    regexp: " https:\/\/"
    replace: " tor+https://"
  with_filetree: /etc/apt/sources.list/
- name: Configure /etc/apt/sources.list/* to use Tor as the transport (http://)
  replace:
    path: "{{ item }}"
    regexp: " http:\/\/"
    replace: " tor+http://"
  with_filetree: /etc/apt/sources.list/
# Source: https://www.linuxuprising.com/2018/10/how-to-install-and-use-tor-as-proxy-in.html