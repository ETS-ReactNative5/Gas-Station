---
- name: Check if VHDX already exists
  win_stat:
    path: "{{ item.vhdx_dest }}"
  register: vhdx_file_info
- name: Create the VM if it does not exist
  win_hyperv_guest:
    name: "{{ item.name }}"
    generation: 2
    cpu: "{{ item.cpu }}"
    memory: "{{ item.memory }}"
    network_switch: "{{ item.network_switch }}"
    diskpath: "{{ item.vhdx_dest }}"
    state: present
  when: item.stat.exists === false
- name: Configure VM's NIC
  win_hyperv_guest_config_net:
    name: "{{ item.name }}"
    ip: "{{ item.network.ip }}"
    netmask: "{{ item.network.netmask }}"
    gateway: "{{ item.network.gateway }}"
    dns: "{{ item.network.dns }}"
    type: static
- add_host:
    name: "{{ item.network.ip }}"
    ansible_connection: "{{ connection_map[item.type] }}"
    ansible_host: "{{ item.network.ip }}"
    groups: "{{ item.type }}"
- name: Power on VM (Windows)
  win_wait_for:
    host: "{{ item.network.ip }}"
    port: "{{ ansible_port }}"
    timeout: 300