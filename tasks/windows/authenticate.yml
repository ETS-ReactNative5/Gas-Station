---
- name: Ensure .ssh folder exists
  win_file:
    path: "%USERPROFILE%\\.ssh"
    state: directory
- name: Copy SSH private keys
  win_copy:
    src: "files/keys/{{ item }}"
    dest: "%USERPROFILE%\\.ssh\\{{ item }}"
  with_items: "{{ ssh_private_keys | default([]) }}"
- name: Copy SSH public keys
  win_copy:
    src: "files/keys/{{ item }}.pub"
    dest: "%USERPROFILE%\\.ssh\\{{ item }}.pub"
  with_items: "{{ ssh_private_keys | default([]) }}"
- name: Copy SSH known hosts
  win_copy:
    src: files/keys/known_hosts
    dest: "%USERPROFILE%\\.ssh\\known_hosts"
- name: Copy SSH config
  win_copy:
    src: files/keys/config
    dest: "%USERPROFILE%\\.ssh\\config"
- name: Ensure proper permissions on the SSH keys
  win_shell: |
    Cmd /c Icacls %USERPROFILE%\\.ssh\\{{ item }} /c /t /Inheritance:d
    Cmd /c Icacls %USERPROFILE%\\.ssh\\{{ item }} /c /t /Grant %UserName%:F
    Cmd /c Icacls %USERPROFILE%\\.ssh\\{{ item }} /c /t /Remove Administrator BUILTIN\Administrators BUILTIN Everyone System Users
  with_items: "{{ ssh_private_keys | default([]) }}"