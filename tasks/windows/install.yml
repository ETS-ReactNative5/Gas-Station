# Copyright 2020, Megabyte LLC <help@megabyte.space>

# This playbook is the main script that makes sure the appropriate software
# is installed for a given environment.

---
- name: Configure Windows optional features
  win_optional_feature:
    include_parent: yes
    name: "{{ item.name | default(item) }}"
    state: "{{ item.state | default('present') }}"
  register: optional_features
  with_items: "{{ windows_features | default([]) }}"
- set_fact:
    needs_reboot: "{{ optional_features | json_query('results[*].reboot_required') }}"
- name: Reboot if the configuration of optional features requires it
  win_reboot:
    post_reboot_delay: 140
  when: True in needs_reboot
- name: Remove unnecessary APPX packages
  win_shell: |
    Get-AppxPackage -AllUsers -Name "{{ item | default(item) }}" | Remove-AppxPackage -AllUsers -ErrorAction SilentlyContinue;
    Get-AppxProvisionedPackage -Online | where {$_.PackageName -like "{{ item | default(item) }}"} | Remove-AppxProvisionedPackage -AllUsers -Online -ErrorAction SilentlyContinue;
  with_items: "{{ appx_removals | default([]) }}"
- name: Install Python
  include_tasks: install-python.yml
- name: Install software via Chocolatey
  include_tasks: tasks/windows/install-package.yml
  with_items: "{{ choco_apps | default([]) }}"
  register: chocolatey_installs
- name: Install Visual Studio Code plugins via Chocolatey
  win_chocolatey:
    name: "{{ item | default(item) }}"
    state: latest
  with_items: "{{ choco_vscode_plugins | default([]) }}"
- name: Install global NPM packages
  win_shell: "npm install -g {{ item }}@latest"
  with_items: "{{ npm_globals | default([]) }}"
- name: Provision VMs
  include_tasks: tasks/hyper-v/provision-vm.yml
  with_items: "{{ vms | default([]) }}"