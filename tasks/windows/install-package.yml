---
- name: "Ensure \"{{ item.name }}\" is installed"
  win_chocolatey:
    ignore_checksums: "{{ item.ignore_checksums | default('no') }}"
    name: "{{ item.name }}"
    params: "{{ item.params | default('') }}"
    state: "{{ item.state | default('present') }}"
  when: item.version is not defined
- name: "Ensure \"{{ item.name }}\" is installed at specific version if specified"
  win_chocolatey:
    ignore_checksums: "{{ item.ignore_checksums | default('no') }}"
    name: "{{ item.name }}"
    params: "{{ item.params | default('') }}"
    version: "{{ item.version }}"
  when: item.version is defined
- name: "Check if \"{{ item.name }}\" has a start menu shortcut in a folder in the Windows shared start menu location"
  win_stat:
    path: "{{ windows_startmenu }}\\{{ windows_software_meta[item.name].folder }}\\{{ windows_software_meta[item.name].link }}.lnk"
  register: startmenu_shortcut
  when:
    - windows_software_meta[item.name].folder is defined
    - windows_software_meta[item.name].link is defined
- name: "Move the \"{{ item.name }}\" shortcut to the parent directory if it resides in a folder"
  win_shell: "mv '{{ windows_startmenu }}\\{{ windows_software_meta[item.name].folder }}\\{{ windows_software_meta[item.name].link }}.lnk' '{{ windows_startmenu }}\\{{ windows_software_meta[item.name].rename | default(windows_software_meta[item.name].link) }}.lnk'"
  when:
   - startmenu_shortcut.stat.exists is defined
   - startmenu_shortcut.stat.exists
- name: "Remove the \"{{ item.name }}\" folder from the start menu if it exists"
  win_file:
    path: "{{ windows_startmenu }}\\{{ windows_software_meta[item.name].folder }}"
    state: absent
  when: windows_software_meta[item.name].folder is defined
- name: "Check if \"{{ item.name }}\" has a start menu shortcut in the user folder location"
  win_stat:
    path: "%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\{{ windows_software_meta[item.name].folder }}\\{{ windows_software_meta[item.name].link }}.lnk"
  register: alt_startmenu_shortcut
  when:
    - windows_software_meta[item.name].folder is defined
    - windows_software_meta[item.name].link is defined
- name: "Move the \"{{ item.name }}\" shortcut to the parent directory if it resides in a folder"
  win_shell: "mv '%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\{{ windows_software_meta[item.name].folder }}\\{{ windows_software_meta[item.name].link }}.lnk' '%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start Mennu\\Programs\\{{ windows_software_meta[item.name].link }}.lnk'"
  when:
    - alt_startmenu_shortcut.stat.exists is defined
    - alt_startmenu_shortcut.stat.exists
- name: Remove the \"{{ item.name }}\" folder from the start menu if it exists
  win_file:
    path: "%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\{{ windows_software_meta[item.name].folder }}"
    state: absent
  when: windows_software_meta[item.name].folder is defined