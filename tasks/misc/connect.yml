---
- name: Attempt to connect on non-standard port first
  wait_for:
    host: "{{ ansible_host }}"
    port: "{{ ansible_port }}"
    timeout: 5
  ignore_errors: yes
  register: ssh_check_test
  delegate_to: localhost
- name: Revert to standard port 22
  set_fact:
    ansible_port: '22'
  when: ssh_check_test.failed
- name: Ensure ansible_user has password set
  become: yes
  user:
    name: "{{ ansible_user }}"
    password: "{{ ansible_password | password_hash('sha512', password_salt) }}"